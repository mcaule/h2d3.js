(function(){var t=window.h2d3||{};window.h2d3=t;t.modeNames={N:"Normal",S:"Stacked",SP:"Percent",C:"Center"};t.hist=function(){var e=600;var r=400;var a=600;var n=400;var i={top:20,right:20,bottom:20,left:20,axis:5};var l=["N","S","SP","C"];var o=[];var s="";var u=d3.format();var c=false;var d=true;var f=[];var h="";var g={};var v={};var m={};var p=null;var _=0;var x=null;var y=null;var k=false;var b,w;var F=false;function S(d,f){_=f.length;p=q(f);var y=f.map(function(t){return t.key});a=e;n=r-i.bottom;var E=[];for(var R=0;R<l.length;R++){if(!(_!=2&&l[R]=="C")&&!(k&&l[R]!="N")&&o.indexOf(l[R])==-1){E.push(l[R])}}if(s=="")s=E[0];else if(E.indexOf(s)==-1){if(k)console.log("h2d3 : mode "+t.modeNames[s]+" not compatible with data (negatives values)");else console.log("h2d3 : mode "+t.modeNames[s]+" not compatible with data");s=E[0]}x=d3.select(d).append("svg").attr("class","h2d3").attr("width",a).attr("height",n+i.bottom).append("g");B(E);var Z=x.select(".h2d3_controls")[0][0].getBBox();var D=d3.scale.category20().domain(d3.range(_));g={color:D};N(y,Z.width);var G=x.select(".h2d3_legend")[0][0].getBBox();var H=Math.max(G.height,Z.height);x.select(".h2d3_controls").attr("transform","translate(0,-"+H+")");i.top=i.top+H;n=n-i.top-i.bottom-i.axis;var I=x.append("g");var J=I.append("g");var K=u;if(s=="SP")K=d3.format("p");else if(s=="C")K=function(t){return u(Math.abs(t))};w=A(K);I.append("g").attr("class","h2d3_axis y").call(w).attr("transform","translate(-"+i.axis+",0)");var L=x.select(".h2d3_axis.y")[0][0].getBBox().width;a=a-(i.left+L)-i.right-i.axis;x.attr("transform","translate("+i.left+","+i.top+")");I.attr("transform","translate("+(i.axis+L)+",0)");b=O(K);I.append("g").attr("class","h2d3_axis x").attr("transform","translate(0,"+(n+i.axis)+")").call(b);var Q=C(b);if(Q>0){n=n-Q;w=A(K);I.select(".h2d3_axis.y").call(w);I.select(".h2d3_axis.x").attr("transform","translate(0,"+(n+i.axis)+")");F=true}if(c){J.attr("transform","rotate(-90) translate(-"+n+",0)")}var T=J.selectAll(".h2d3_group").data(p).enter().append("g").attr("class","h2d3_group").attr("transform",function(t){return"translate(0,"+g.group(t.label)+")"});var U=v[s];T.selectAll(".h2d3_bar").data(function(t){t.series.sort(function(t,e){return m[t.key].index-m[e.key].index});P(t);return t.series}).enter().append("rect").attr("class",function(t){return"h2d3_bar h2d3_serie_"+M(t.key)}).attr("fill",function(t){return D(m[t.key].index)}).call(U);if(h!=""){j(h)}S.sort=j;S.changeMode=z;S.hide=V}S.vertical=function(t){if(!arguments.length||t)c=true;return S};S.width=function(t){if(!arguments.length)return e;e=t;return S};S.height=function(t){if(!arguments.length)return r;r=t;return S};S.tickFormat=function(t){if(!arguments.length)return u;u=t;return S};S.selectSeries=function(t){if(!arguments.length)return d;d=t;return S};S.margin=function(t){if(!arguments.length)return i;i=t;return S};S.percentMode=function(t){if(!arguments.length){s="SP";return S}if(!arguments[0])o.push("SP");if(arguments.length>1&&arguments[1])s="SP";return S};S.stackedMode=function(t){if(!arguments.length){s="S";return S}if(!arguments[0])o.push("S");if(arguments.length>1&&arguments[1])s="S";return S};S.normalMode=function(t){if(!arguments.length){s="N";return S}if(!arguments[0])o.push("N");if(arguments.length>1&&arguments[1])s="N";return S};S.centerMode=function(t){if(!arguments.length){s="C";return S}if(!arguments[0])o.push("C");if(arguments.length>1&&arguments[1])s="C";return S};S.sort=function(t){if(!arguments.length)return h;h=t;return S};var B=function(e){var r=e.length>1?e:[];x.append("g").attr("class","h2d3_controls").selectAll("g").data(r).enter().append("g").attr("class","h2d3_ctrl").attr("transform",function(t,e){return"translate(0,"+e*16+")"}).each(function(e,r){var a=d3.select(this);a.append("circle").attr("class","h2d3_ctrl_circle").attr("r","5");a.append("circle").attr("class",function(){if(e==s)return"h2d3_ctrl_dot h2d3_ctrl_dot_selected";else return"h2d3_ctrl_dot"}).attr("r","2");a.append("text").attr("class","h2d3_ctrl_text").attr("dy",".32em").attr("dx","8").attr("text-anchor","start").text(function(){return t.modeNames[e]})}).on("click",function(t){if(t!=s){var e=d3.select(this.parentNode).selectAll(".h2d3_ctrl_dot_selected").attr("class","h2d3_ctrl_dot");z(t);d3.select(this).selectAll(".h2d3_ctrl_dot").attr("class","h2d3_ctrl_dot_selected")}})};var N=function(t,r){var a=20;var n=5;function l(t){var e=window.getComputedStyle(t,null).getPropertyValue("fill");d3.select(t).attr("stroke",e).attr("stroke-width","2.5").attr("fill","#FFFFFF").attr("class","h2d3_legend_item_circle")}function o(t){var e=window.getComputedStyle(t,null).getPropertyValue("stroke");d3.select(t).attr("stroke","#FFFFFF").attr("stroke-width","0.5").attr("fill",e)}x.append("g").attr("class","h2d3_legend").selectAll("g").data(t).enter().append("g").attr("class","h2d3_legend_item").style("cursor",d?"pointer":"auto").each(function(t,e){var r=d3.select(this);r.append("circle").attr("class",function(){return"h2d3_legend_item_circle h2d3_serie_"+M(t)}).attr("fill",function(t){return g.color(m[t].index)}).attr("stroke-width","0.5").attr("stroke","#FFFFFF").attr("r","5");r.append("text").attr("class",function(){return"h2d3_legend_item_text h2d3_serie_"+M(t)}).attr("dy",".32em").attr("dx","8").attr("text-anchor","start").attr("fill",function(t){return g.color(m[t].index)}).text(function(){return t})}).on("click",function(t){if(!d)return;if(f.indexOf(t)==-1){f.push(t);V(f);l(this.getElementsByClassName("h2d3_legend_item_circle")[0])}else{var e=f.indexOf(t);f.splice(e,1);V(f);o(this.getElementsByClassName("h2d3_legend_item_circle")[0])}});var s=x.select(".h2d3_legend")[0][0].getBBox().width+n;var u=1;while(Math.ceil(_/u)*s>e-r-a&&u<_)u++;x.selectAll(".h2d3_legend_item").attr("transform",function(t,e){return"translate("+Math.floor(e/u)*s+","+e%u*16+")"});x.select(".h2d3_legend").attr("transform",function(t,r){return"translate("+(e-i.left-i.right-s*Math.ceil(_/u))+",-"+u*16+")"})};function M(t){return t.replace(/[^A-Za-z0-9]/g,"-")}function P(t){var e=0;var r=0;t.series.forEach(function(a){a.cumx=e;a.cumxp=r;a.percent=a.value/t.total;e+=a.value;r+=a.percent})}var C=function(t){var e=t.scale();if(c){var r=e.rangeBand();var a=0;x.select(".h2d3_axis.x").selectAll("text").each(function(){a=Math.max(this.getBBox().width,a)});if(a<r)return 0;x.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end").attr("transform","rotate(-30)");return x.select(".h2d3_axis.x")[0][0].getBBox().height}return 0};var A=function(t){var e=d3.svg.axis();var r;if(c){R();r=g["bar_"+s].copy();r.range([n,0]);e.tickFormat(t)}else{E();r=g.group}e.scale(r).orient("left");return e};var O=function(t){var e=d3.svg.axis();if(c){E();r=g.group}else{R();var r=g["bar_"+s];e.tickFormat(t)}e.scale(r).orient("bottom");return e};var E=function(){var t=c?a:n;g.group=d3.scale.ordinal().domain(p.map(function(t){return t.label})).rangeRoundBands([0,t],.1);g.group_N=d3.scale.ordinal().domain(d3.range(_-f.length)).rangeRoundBands([0,g.group.rangeBand()])};var R=function(){var t=c?n:a;var e=999999999;var r=-999999999;var i=e;var l=r;p.forEach(function(t){var a=0;t.series.forEach(function(t,n){var i=t.value;e=Math.min(i,e);r=Math.max(i,r);a+=i;if(m[t.key].total>0)t.norm_value=i/m[t.key].total});t.total=a;l=Math.max(l,a);i=Math.min(i,a)});g.bar_N=d3.scale.linear().range([0,t]).domain([Math.min(0,e),r]);g.bar_S=d3.scale.linear().range([0,t]).domain([0,l]);g.bar_SP=d3.scale.linear().range([0,t]).domain([0,1]);g.bar_C=d3.scale.linear().range([0,t]).domain([-r,r])};v.N=function(t){var e=g.bar_N;t.attr("width",function(t){return Math.abs(e(t.value)-e(0))}).attr("height",g.group_N.rangeBand()).attr("x",function(t){return e(Math.min(0,t.value))}).attr("y",function(t,e){return g.group_N(m[t.key].index)})},v.S=function(t){var e=g.bar_S;t.attr("width",function(t){return e(t.value)}).attr("height",g.group.rangeBand()).attr("x",function(t){return e(t.cumx)}).attr("y",0)},v.SP=function(t){var e=g.bar_SP;t.attr("width",function(t){return e(t.percent)}).attr("height",g.group.rangeBand()).attr("x",function(t){return e(t.cumxp)}).attr("y",0)},v.C=function(t){var e=g.bar_C;t.attr("width",function(t){return e(t.value)-e(0)}).attr("height",g.group.rangeBand()).attr("x",function(t,r){return m[t.key].index%2==0?e(-t.value):e(0)}).attr("y",0)};var V=function(t){f=t;p.map(function(e){var r=0;e.series.map(function(e){if(t.indexOf(e.key)>-1&&!e.hasOwnProperty("hvalue")){e.hvalue=e.value;e.value=0}else if(t.indexOf(e.key)==-1&&e.hasOwnProperty("hvalue")){e.value=e.hvalue;delete e.hvalue}r+=e.value});if(r==0)r=1;e.total=r});p.forEach(function(t){P(t)});R();Z()};var z=function(t){if(s==t)return;s=t;Z()};var Z=function(){var t=x.transition().duration(500);var e=g["bar_"+s];if(c){e=e.copy();e.range([n,0])}var r=d3.svg.axis().scale(e).orient(c?"left":"bottom");if(s=="SP")r.tickFormat(d3.format("p"));else if(s=="C")r.tickFormat(function(t){return u(Math.abs(t))});else r.tickFormat(u);t.select(c?".y.h2d3_axis":".x.h2d3_axis").call(r);var a=v[s];t.selectAll(".h2d3_group rect.h2d3_bar").call(a)};var j=function(t){if(t==""||t[0]!="-"){e=1}else{var e=-1;t=t.slice(1)}if(t==""){for(var r in m){if(m.hasOwnProperty(r)){m[r].index=m[r].initial}}p.forEach(function(t){t.series.sort(function(t,e){return m[t.key].index-m[e.key].index});P(t)});p.sort(function(t,e){return t.initial-e.initial})}else{var a=-1;var n=null;for(var r in m){if(m.hasOwnProperty(r)){if(m[r].index==0)n=m[r];if(r==t){a=m[r].index;m[r].index=0}}}if(a==-1)console.error("serie not found : ",t);if(n!=null)n.index=a;p.forEach(function(t){t.series.sort(function(t,e){return m[t.key].index-m[e.key].index});P(t)});var i=s=="SP"?"percent":"value";p.sort(function(r,a){var n=r.series[0].key==t?r.series[0][i]:0;var l=a.series[0].key==t?a.series[0][i]:0;return e*(n-l)})}g.group=g.group.domain(p.map(function(t){return t.label})).copy();var l=(c?b:w).scale(g.group);var o=x.transition().duration(500);o.select(c?".h2d3_axis.x":".h2d3_axis.y").delay(500).call(l);if(F){x.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end")}o.selectAll(".h2d3_group").attr("transform",function(t){return"translate(0,"+g.group(t.label)+")"}).delay(500);var u=v[s];o.selectAll(".h2d3_group rect.h2d3_bar").call(u)};var q=function(t){var e={};var r=[];t.forEach(function(t,a){var n={key:t.key,index:a,initial:a};var i=0;t.values.forEach(function(a,n){if(!e.hasOwnProperty(a.label)){var l=r.length;e[a.label]={label:a.label,series:[],initial:l};r.push(e[a.label])}e[a.label].series.push({key:t.key,value:a.value});i+=a.value;if(a.value<0)k=true});if(i==0)i=1;n.total=i;m[t.key]=n});e=null;return r};return S}})();