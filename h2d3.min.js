(function(){var t=window.h2d3||{};window.h2d3=t;t.modeNames={N:"Normal",S:"Stacked",SP:"Percent",C:"Center"};t.styles={"default":["#a6cee3","#ff7f00","#b2df8a","#1f78b4","#fdbf6f","#33a02c","#cab2d6","#6a3d9a","#fb9a99","#e31a1c","#ffff99","#b15928"],pastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"],darkpastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"],colorblind:["#999999","#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7"]};t.chart=function(){var e=600;var r=400;var a=600;var n=400;var i={top:20,right:20,bottom:20,left:20,axis:5};var l=["N","S","SP","C"];var s=[];var o="";var u=d3.format();var c=u;var d=false;var f=true;var h=[];var g="";var v=null;var p={};var m={};var x={};var _=null;var y=0;var b=null;var k=null;var A=false;var w,B;var C=false;var E="default";var S=d3.hasOwnProperty("tip");var P=null;function N(f,h){y=h.length;_=L(h);var k=h.map(function(t){return t.key});a=e;n=r-i.bottom;var j=[];for(var q=0;q<l.length;q++){if(!(y!=2&&l[q]=="C")&&!(A&&l[q]!="N")&&s.indexOf(l[q])==-1){j.push(l[q])}}if(o=="")o=j[0];else if(j.indexOf(o)==-1){if(A)console.log("h2d3 : mode "+t.modeNames[o]+" not compatible with data (negatives values)");else console.log("h2d3 : mode "+t.modeNames[o]+" not compatible with data");o=j[0]}b=d3.select(f).append("svg").attr("class","h2d3 "+E).attr("width",a).attr("height",n+i.bottom).append("g");M(j);var J=b.select(".h2d3_controls")[0][0].getBBox();var Q=d3.scale.ordinal().domain(d3.range(y));if(v==null)Q.range(t.styles[E]);else Q.range(v);p={color:Q};O(k,J.width);var T=b.select(".h2d3_legend")[0][0].getBBox();var U=Math.max(T.height,J.height);b.select(".h2d3_controls").attr("transform","translate(0,-"+U+")");i.top=i.top+U;n=n-i.top-i.bottom-i.axis;var W=b.append("g");var X=W.append("g");c=u;if(o=="SP")c=d3.format(".2p");else if(o=="C")c=function(t){return u(Math.abs(t))};B=z();W.append("g").attr("class","h2d3_axis y "+E+" "+(d?"barAxis":"groupAxis")).call(B).attr("transform","translate(-"+i.axis+",0)");var Y=b.select(".h2d3_axis.y")[0][0].getBBox().width;a=a-(i.left+Y)-i.right-i.axis;b.attr("transform","translate("+i.left+","+i.top+")");W.attr("transform","translate("+(i.axis+Y)+",0)");w=Z();W.append("g").attr("class","h2d3_axis x "+E+" "+(d?"groupAxis":"barAxis")).attr("transform","translate(0,"+(n+i.axis)+")").call(w);var $=V(w);if($>0){n=n-$;B=z();W.select(".h2d3_axis.y").call(B);W.select(".h2d3_axis.x").attr("transform","translate(0,"+(n+i.axis)+")");C=true}W.insert("rect",":first-child").attr("width",a+i.axis).attr("height",n+i.axis).attr("x",-i.axis).attr("y",0).attr("class","h2d3_gridbg "+E);X.selectAll("h2d3_grid").call(G);if(d){X.attr("transform","rotate(-90) translate(-"+n+",0)")}if(S){D();X.call(P)}var te=X.selectAll(".h2d3_group").data(_).enter().append("g").attr("class","h2d3_group").attr("transform",function(t){return"translate(0,"+p.group(t.label)+")"});var ee=m[o];var re=te.selectAll(".h2d3_bar").data(function(t){t.series.sort(function(t,e){return x[t.key].index-x[e.key].index});R(t);return t.series}).enter().append("rect").attr("class",function(t){return"h2d3_bar h2d3_serie_"+F(t.key)}).attr("fill",function(t){return Q(x[t.key].index)}).call(ee);if(S){re.on("mouseover",P.show).on("mouseout",P.hide)}if(g!=""){K(g)}N.sort=K;N.changeMode=I;N.hide=H}N.vertical=function(t){if(!arguments.length||t)d=true;return N};N.width=function(t){if(!arguments.length)return e;e=t;return N};N.height=function(t){if(!arguments.length)return r;r=t;return N};N.tickFormat=function(t){if(!arguments.length)return u;if(typeof t=="string")t=d3.format(t);u=t;return N};N.selectSeries=function(t){if(!arguments.length)return f;f=t;return N};N.colors=function(t){if(!arguments.length)return v;v=t;return N};N.margin=function(t){if(!arguments.length)return i;i=t;return N};N.percentMode=function(t){if(!arguments.length){o="SP";return N}if(!arguments[0])s.push("SP");if(arguments.length>1&&arguments[1])o="SP";return N};N.stackedMode=function(t){if(!arguments.length){o="S";return N}if(!arguments[0])s.push("S");if(arguments.length>1&&arguments[1])o="S";return N};N.normalMode=function(t){if(!arguments.length){o="N";return N}if(!arguments[0])s.push("N");if(arguments.length>1&&arguments[1])o="N";return N};N.centerMode=function(t){if(!arguments.length){o="C";return N}if(!arguments[0])s.push("C");if(arguments.length>1&&arguments[1])o="C";return N};N.sort=function(t){if(!arguments.length)return g;g=t;return N};N.style=function(e){if(!arguments.length)return E;if(t.styles.hasOwnProperty(e))E=e;return N};var M=function(e){var r=e.length>1?e:[];b.append("g").attr("class","h2d3_controls").selectAll("g").data(r).enter().append("g").attr("class","h2d3_ctrl "+E).style("cursor","pointer").attr("pointer-events","all").attr("transform",function(t,e){return"translate(0,"+e*16+")"}).each(function(e,r){var a=d3.select(this);a.append("circle").attr("class","h2d3_ctrl_circle "+E).attr("r","5");a.append("circle").attr("class",function(){if(e==o)return"h2d3_ctrl_dot h2d3_ctrl_dot_selected "+E;else return"h2d3_ctrl_dot "+E}).attr("r","2");a.append("text").attr("class","h2d3_ctrl_text").attr("dy",".32em").attr("dx","8").attr("text-anchor","start").text(function(){return t.modeNames[e]})}).on("click",function(t){if(t!=o){var e=d3.select(this.parentNode).selectAll(".h2d3_ctrl_dot_selected").attr("class","h2d3_ctrl_dot "+E);I(t);d3.select(this).selectAll(".h2d3_ctrl_dot").attr("class","h2d3_ctrl_dot h2d3_ctrl_dot_selected "+E)}})};var O=function(t,r){var a=20;var n=5;function l(t){var e=window.getComputedStyle(t,null).getPropertyValue("fill");d3.select(t).attr("stroke",e).attr("stroke-width","2.5").attr("fill","none").attr("class","h2d3_legend_item_circle")}function s(t){var e=window.getComputedStyle(t,null).getPropertyValue("stroke");d3.select(t).attr("stroke","none").attr("stroke-width","0.5").attr("fill",e)}b.append("g").attr("class","h2d3_legend").selectAll("g").data(t).enter().append("g").attr("class","h2d3_legend_item").style("cursor",f?"pointer":"auto").attr("pointer-events","all").each(function(t,e){var r=d3.select(this);r.append("circle").attr("class",function(){return"h2d3_legend_item_circle h2d3_serie_"+F(t)}).attr("fill",function(t){return p.color(x[t].index)}).attr("stroke-width","0.5").attr("stroke","none").attr("r","5");r.append("text").attr("class",function(){return"h2d3_legend_item_text h2d3_serie_"+F(t)}).attr("dy",".32em").attr("dx","8").attr("text-anchor","start").attr("fill",function(t){return p.color(x[t].index)}).text(function(){return t})}).on("click",function(t){if(!f)return;if(h.indexOf(t)==-1){h.push(t);H(h);l(this.getElementsByClassName("h2d3_legend_item_circle")[0])}else{var e=h.indexOf(t);h.splice(e,1);H(h);s(this.getElementsByClassName("h2d3_legend_item_circle")[0])}});var o=b.select(".h2d3_legend")[0][0].getBBox().width+n;var u=1;while(Math.ceil(y/u)*o>e-r-a&&u<y)u++;b.selectAll(".h2d3_legend_item").attr("transform",function(t,e){return"translate("+Math.floor(e/u)*o+","+e%u*16+")"});b.select(".h2d3_legend").attr("transform",function(t,r){return"translate("+(e-i.left-i.right-o*Math.ceil(y/u))+",-"+u*16+")"})};var D=function(){P=d3.tip().attr("class","h2d3-tip "+E).offset([-10,0]).direction("n").html(function(t){var e=o=="SP"?t.percent:t.value;return' <span style="color:'+p.color(x[t.key].index)+'">'+t.key+'</span><span class="h2d3-tip_text '+E+'" > : '+c(e)+"</span>"});if(d){P.offset(function(t){var e=this.getAttribute("height");var r=this.getAttribute("width");return[-r/2-10,e/2]})}return P};function F(t){return t.replace(/[^A-Za-z0-9]/g,"-")}function R(t){var e=0;var r=0;t.series.forEach(function(a){a.cumx=e;a.cumxp=r;a.percent=a.value/t.total;e+=a.value;r+=a.percent})}var V=function(t){var e=t.scale();if(d){var r=e.rangeBand();var a=0;b.select(".h2d3_axis.x").selectAll("text").each(function(){a=Math.max(this.getBBox().width,a)});if(a<r)return 0;b.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end").attr("transform","rotate(-30)");return b.select(".h2d3_axis.x")[0][0].getBBox().height}return 0};var z=function(){var t=d3.svg.axis();var e;if(d){q();e=p["bar_"+o].copy();e.range([n,0]);t.tickFormat(c)}else{j();e=p.group}t.scale(e).orient("left");return t};var Z=function(){var t=d3.svg.axis();if(d){j();e=p.group}else{q();var e=p["bar_"+o];t.tickFormat(c)}t.scale(e).orient("bottom");return t};var j=function(){var t=d?a:n;p.group=d3.scale.ordinal().domain(_.map(function(t){return t.label})).rangeRoundBands([0,t],.1);p.group_N=d3.scale.ordinal().domain(d3.range(y)).rangeRoundBands([0,p.group.rangeBand()])};var q=function(){var t=d?n:a;var e=999999999;var r=-999999999;var i=e;var l=r;_.forEach(function(t){var a=0;t.series.forEach(function(t,n){var i=t.value;e=Math.min(i,e);r=Math.max(i,r);a+=i;if(x[t.key].total>0)t.norm_value=i/x[t.key].total});t.total=a;l=Math.max(l,a);i=Math.min(i,a)});p.bar_N=d3.scale.linear().range([0,t]).domain([Math.min(0,e),r]);p.bar_S=d3.scale.linear().range([0,t]).domain([0,l]);p.bar_SP=d3.scale.linear().range([0,t]).domain([0,1]);p.bar_C=d3.scale.linear().range([0,t]).domain([-r,r])};m.N=function(t){var e=p.bar_N;t.attr("width",function(t){return Math.abs(e(t.value)-e(0))}).attr("height",p.group_N.rangeBand()).attr("x",function(t){return e(Math.min(0,t.value))}).attr("y",function(t,e){var r=p.group_N(x[t.key].index);if(r!==undefined)return r;return this.getAttribute("y")})},m.S=function(t){var e=p.bar_S;t.attr("width",function(t){return e(t.value)}).attr("height",p.group.rangeBand()).attr("x",function(t){return e(t.cumx)}).attr("y",0)},m.SP=function(t){var e=p.bar_SP;t.attr("width",function(t){return e(t.percent)}).attr("height",p.group.rangeBand()).attr("x",function(t){return e(t.cumxp)}).attr("y",0)},m.C=function(t){var e=p.bar_C;t.attr("width",function(t){return e(t.value)-e(0)}).attr("height",p.group.rangeBand()).attr("x",function(t,r){return x[t.key].index%2==0?e(-t.value):e(0)}).attr("y",0)};var G=function(t){var e=d?a:n;var r=p["bar_"+o];t.data(r.ticks(10)).enter().append("line").attr("class","h2d3_grid "+E).attr("y1",d?-i.axis:0).attr("y2",d?e:e+i.axis).attr("x1",function(t){return r(t)}).attr("x2",function(t){return r(t)})};var H=function(t){h=t;_.map(function(e){var r=0;e.series.map(function(e){if(t.indexOf(e.key)>-1&&!e.hasOwnProperty("hvalue")){e.hvalue=e.value;e.value=0}else if(t.indexOf(e.key)==-1&&e.hasOwnProperty("hvalue")){e.value=e.hvalue;delete e.hvalue}r+=e.value});if(r==0)r=1;e.total=r});_.forEach(function(t){R(t)});q();var e=d3.range(y);h.forEach(function(t){e.splice(e.indexOf(x[t].index),1)});p.group_N.domain(e);J()};var I=function(t){if(o==t)return;o=t;J()};var J=function(){var t=b.transition().duration(500);var e=p["bar_"+o];if(d){e=e.copy();e.range([n,0])}var r=d3.svg.axis().scale(e).orient(d?"left":"bottom");c=u;if(o=="SP")c=d3.format(".2p");else if(o=="C")c=function(t){return u(Math.abs(t))};r.tickFormat(c);t.select(d?".y.h2d3_axis":".x.h2d3_axis").call(r);var a=m[o];t.selectAll(".h2d3_group rect.h2d3_bar").call(a)};var K=function(t){if(t==""||t[0]!="-"){e=1}else{var e=-1;t=t.slice(1)}if(t==""){for(var r in x){if(x.hasOwnProperty(r)){x[r].index=x[r].initial}}_.forEach(function(t){t.series.sort(function(t,e){return x[t.key].index-x[e.key].index});R(t)});_.sort(function(t,e){return t.initial-e.initial})}else{var a=-1;var n=null;for(var r in x){if(x.hasOwnProperty(r)){if(x[r].index==0)n=x[r];if(r==t){a=x[r].index;x[r].index=0}}}if(a==-1)console.error("serie not found : ",t);if(n!=null)n.index=a;_.forEach(function(t){t.series.sort(function(t,e){return x[t.key].index-x[e.key].index});R(t)});var i=o=="SP"?"percent":"value";_.sort(function(r,a){var n=r.series[0].key==t?r.series[0][i]:0;var l=a.series[0].key==t?a.series[0][i]:0;return e*(n-l)})}p.group=p.group.domain(_.map(function(t){return t.label})).copy();var l=(d?w:B).scale(p.group);var s=b.transition().duration(500);s.select(d?".h2d3_axis.x":".h2d3_axis.y").delay(500).call(l);if(C){b.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end")}s.selectAll(".h2d3_group").attr("transform",function(t){return"translate(0,"+p.group(t.label)+")"}).delay(500);var u=m[o];s.selectAll(".h2d3_group rect.h2d3_bar").call(u)};var L=function(t){var e={};var r=[];t.forEach(function(t,a){var n={key:t.key,index:a,initial:a};var i=0;t.values.forEach(function(a,n){if(!e.hasOwnProperty(a.label)){var l=r.length;e[a.label]={label:a.label,series:[],initial:l};r.push(e[a.label])}e[a.label].series.push({key:t.key,value:a.value});i+=a.value;if(a.value<0)A=true});if(i==0)i=1;n.total=i;x[t.key]=n});e=null;return r};return N}})();