(function(t){if(typeof define==="function"&&define.amd){define(["d3","d3-tip"],t)}else{if(d3&&d3.tip)window.h2d3=t(d3,d3.tip);else window.h2d3=t(d3)}})(function(t,e){var r={};var a=!(typeof e==="undefined");r.modeNames={N:"Normal",S:"Stacked",SP:"Percent",C:"Center"};r.styles={"default":["#a6cee3","#ff7f00","#b2df8a","#1f78b4","#fdbf6f","#33a02c","#cab2d6","#6a3d9a","#fb9a99","#e31a1c","#ffff99","#b15928"],pastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"],darkpastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"],colorblind:["#999999","#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7"]};r.chart=function(){var n=600;var i=400;var l=600;var o=400;var s={top:20,right:20,bottom:20,left:20,axis:5};var u=["N","S","SP","C"];var c=[];var f="";var d=t.format();var h=d;var v=false;var g=true;var p=[];var m="";var x=null;var _={};var y={};var b={};var k=null;var w=0;var A=null;var B=null;var C=false;var E,S;var N=false;var P="default";var M=function(t){var e=f=="SP"?t.percent:t.value;return' <span style="color:'+_.color(b[t.key].index)+'">'+t.key+'</span><span class="h2d3-tip_text '+P+'" > : '+h(e)+"</span>"};var D=null;function O(e,g){w=g.length;k=U(g);var p=g.map(function(t){return t.key});l=n;o=i-s.bottom;var B=[];for(var M=0;M<u.length;M++){if(!(w!=2&&u[M]=="C")&&!(C&&u[M]!="N")&&c.indexOf(u[M])==-1){B.push(u[M])}}if(f=="")f=B[0];else if(B.indexOf(f)==-1){if(C)console.log("h2d3 : mode "+r.modeNames[f]+" not compatible with data (negatives values)");else console.log("h2d3 : mode "+r.modeNames[f]+" not compatible with data");f=B[0]}A=t.select(e).append("svg").attr("class","h2d3 "+P).attr("width",l).attr("height",o+s.bottom).append("g");F(B);var H=A.select(".h2d3_controls")[0][0].getBBox();var I=t.scale.ordinal().domain(t.range(w));if(x==null)I.range(r.styles[P]);else I.range(x);_={color:I};z(p,H.width);var Q=A.select(".h2d3_legend")[0][0].getBBox();var W=Math.max(Q.height,H.height);A.select(".h2d3_controls").attr("transform","translate(0,-"+W+")");s.top=s.top+W;o=o-s.top-s.bottom-s.axis;var X=A.append("g");h=d;if(f=="SP")h=t.format(".2p");else if(f=="C")h=function(t){return d(Math.abs(t))};S=q();X.append("g").attr("class","h2d3_axis y "+P+" "+(v?"barAxis":"groupAxis")).call(S).attr("transform","translate(-"+s.axis+",0)");var Y=A.select(".h2d3_axis.y")[0][0].getBBox().width;l=l-(s.left+Y)-s.right-s.axis;A.attr("transform","translate("+s.left+","+s.top+")");X.attr("transform","translate("+(s.axis+Y)+",0)");E=G();X.append("g").attr("class","h2d3_axis x "+P+" "+(v?"groupAxis":"barAxis")).attr("transform","translate(0,"+(o+s.axis)+")").call(E);var $=Z(E);if($>0){o=o-$;S=q();X.select(".h2d3_axis.y").call(S);X.select(".h2d3_axis.x").attr("transform","translate(0,"+(o+s.axis)+")");N=true}X.insert("rect",":first-child").attr("width",l+s.axis).attr("height",o+s.axis).attr("x",-s.axis).attr("y",0).attr("class","h2d3_gridbg "+P);J(X);var te=X.append("g");if(v){te.attr("transform","rotate(-90) translate(-"+o+",0)")}if(a){R();te.call(D)}var ee=te.selectAll(".h2d3_group").data(k).enter().append("g").attr("class","h2d3_group").attr("transform",function(t){return"translate(0,"+_.group(t.label)+")"});var re=y[f];var ae=ee.selectAll(".h2d3_bar").data(function(t){t.series.sort(function(t,e){return b[t.key].index-b[e.key].index});j(t);return t.series}).enter().append("rect").attr("class",function(t){return"h2d3_bar h2d3_serie_"+V(t.key)}).attr("fill",function(t){return I(b[t.key].index)}).call(re);if(a){ae.on("mouseover",D.show).on("mouseout",D.hide)}if(m!=""){T(m)}O.sort=T;O.changeMode=L;O.hide=K}O.vertical=function(t){if(!arguments.length||t)v=true;return O};O.width=function(t){if(!arguments.length)return n;n=t;return O};O.height=function(t){if(!arguments.length)return i;i=t;return O};O.tickFormat=function(e){if(!arguments.length)return d;if(typeof e=="string")e=t.format(e);d=e;return O};O.selectSeries=function(t){if(!arguments.length)return g;g=t;return O};O.colors=function(t){if(!arguments.length)return x;x=t;return O};O.margin=function(t){if(!arguments.length)return s;s=t;return O};O.percentMode=function(t){if(!arguments.length){f="SP";return O}if(!arguments[0])c.push("SP");if(arguments.length>1&&arguments[1])f="SP";return O};O.stackedMode=function(t){if(!arguments.length){f="S";return O}if(!arguments[0])c.push("S");if(arguments.length>1&&arguments[1])f="S";return O};O.normalMode=function(t){if(!arguments.length){f="N";return O}if(!arguments[0])c.push("N");if(arguments.length>1&&arguments[1])f="N";return O};O.centerMode=function(t){if(!arguments.length){f="C";return O}if(!arguments[0])c.push("C");if(arguments.length>1&&arguments[1])f="C";return O};O.sort=function(t){if(!arguments.length)return m;m=t;return O};O.style=function(t){if(!arguments.length)return P;if(r.styles.hasOwnProperty(t))P=t;return O};O.tipFunction=function(t){if(!arguments.length)return M;M=t;return O};O.updateData=function(e){function r(t,e){for(var r=0;r<k.length;r++){if(k[r].label==t){for(var a=0;a<k[r].series.length;a++){if(k[r].series[a].key==e)return k[r].series[a].value}return null}}return null}function a(t,r){for(var a=0;a<e.length;a++){if(e[a].key==r){for(var n=0;n<e[a].values.length;n++){if(e[a].values[n].label==t)return e[a].values[n].value}return null}}return null}for(var n=0;n<e.length;n++){for(var i=0;i<e[n].values.length;i++){var l=r(e[n].values[i].label,e[n].key);if(l===null){console.error("[h2d3.js] Error : incorrect updateData, item does not exist in previous data :",e[n].values[i].label,e[n].key);return}}}k.map(function(t){var e=0;t.series.map(function(r){r.value=a(t.label,r.key);if(r.hasOwnProperty("hvalue")){r.hvalue=r.value;r.value=0}e+=r.value});if(e==0)e=1;t.total=e});k.forEach(function(t){j(t)});I();var o=t.range(w);p.forEach(function(t){o.splice(o.indexOf(b[t].index),1)});_.group_N.domain(o);Q();return O};var F=function(e){var a=e.length>1?e:[];A.append("g").attr("class","h2d3_controls").selectAll("g").data(a).enter().append("g").attr("class","h2d3_ctrl "+P).style("cursor","pointer").attr("pointer-events","all").attr("transform",function(t,e){return"translate(0,"+e*16+")"}).each(function(e,a){var n=t.select(this);n.append("circle").attr("class","h2d3_ctrl_circle "+P).attr("r","5");n.append("circle").attr("class",function(){if(e==f)return"h2d3_ctrl_dot h2d3_ctrl_dot_selected "+P;else return"h2d3_ctrl_dot "+P}).attr("r","2");n.append("text").attr("class","h2d3_ctrl_text").attr("dy",".32em").attr("dx","8").attr("text-anchor","start").text(function(){return r.modeNames[e]})}).on("click",function(e){if(e!=f){var r=t.select(this.parentNode).selectAll(".h2d3_ctrl_dot_selected").attr("class","h2d3_ctrl_dot "+P);L(e);t.select(this).selectAll(".h2d3_ctrl_dot").attr("class","h2d3_ctrl_dot h2d3_ctrl_dot_selected "+P)}})};var z=function(e,r){var a=20;var i=5;function l(e){var r=window.getComputedStyle(e,null).getPropertyValue("fill");t.select(e).attr("stroke",r).attr("stroke-width","2.5").attr("fill","none").attr("class","h2d3_legend_item_circle")}function o(e){var r=window.getComputedStyle(e,null).getPropertyValue("stroke");t.select(e).attr("stroke","none").attr("stroke-width","0.5").attr("fill",r)}A.append("g").attr("class","h2d3_legend").selectAll("g").data(e).enter().append("g").attr("class","h2d3_legend_item").style("cursor",g?"pointer":"auto").attr("pointer-events","all").each(function(e,r){var a=t.select(this);a.append("circle").attr("class",function(){return"h2d3_legend_item_circle h2d3_serie_"+V(e)}).attr("fill",function(t){return _.color(b[t].index)}).attr("stroke-width","0.5").attr("stroke","none").attr("r","5");a.append("text").attr("class",function(){return"h2d3_legend_item_text h2d3_serie_"+V(e)}).attr("dy",".32em").attr("dx","8").attr("text-anchor","start").attr("fill",function(t){return _.color(b[t].index)}).text(function(){return e})}).on("click",function(t){if(!g)return;if(p.indexOf(t)==-1){p.push(t);K(p);l(this.getElementsByClassName("h2d3_legend_item_circle")[0])}else{var e=p.indexOf(t);p.splice(e,1);K(p);o(this.getElementsByClassName("h2d3_legend_item_circle")[0])}});var u=A.select(".h2d3_legend")[0][0].getBBox().width+i;var c=1;while(Math.ceil(w/c)*u>n-r-a&&c<w)c++;A.selectAll(".h2d3_legend_item").attr("transform",function(t,e){return"translate("+Math.floor(e/c)*u+","+e%c*16+")"});A.select(".h2d3_legend").attr("transform",function(t,e){return"translate("+(n-s.left-s.right-u*Math.ceil(w/c))+",-"+c*16+")"})};var R=function(){D=e().attr("class","h2d3-tip "+P).offset([-10,0]).direction("n").html(M);if(v){D.offset(function(t){var e=this.getAttribute("height");var r=this.getAttribute("width");return[-r/2-10,e/2]})}return D};function V(t){return t.replace(/[^A-Za-z0-9]/g,"-")}function j(t){var e=0;var r=0;t.series.forEach(function(a){a.cumx=e;a.cumxp=r;a.percent=a.value/t.total;e+=a.value;r+=a.percent})}var Z=function(t){var e=t.scale();if(v){var r=e.rangeBand();var a=0;A.select(".h2d3_axis.x").selectAll("text").each(function(){a=Math.max(this.getBBox().width,a)});if(a<r)return 0;A.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end").attr("transform","rotate(-30)");return A.select(".h2d3_axis.x")[0][0].getBBox().height}return 0};var q=function(){var e=t.svg.axis();var r;if(v){I();r=_["bar_"+f].copy();r.range([o,0]);e.tickFormat(h)}else{H();r=_.group}e.scale(r).orient("left");return e};var G=function(){var e=t.svg.axis();if(v){H();r=_.group}else{I();var r=_["bar_"+f];e.tickFormat(h)}e.scale(r).orient("bottom");return e};var H=function(){var e=v?l:o;_.group=t.scale.ordinal().domain(k.map(function(t){return t.label})).rangeRoundBands([0,e],.1);_.group_N=t.scale.ordinal().domain(t.range(w)).rangeRoundBands([0,_.group.rangeBand()])};var I=function(){var e=v?o:l;var r=999999999;var a=-999999999;var n=r;var i=a;k.forEach(function(t){var e=0;t.series.forEach(function(t,n){var i=t.value;r=Math.min(i,r);a=Math.max(i,a);e+=i;if(b[t.key].total>0)t.norm_value=i/b[t.key].total});t.total=e;i=Math.max(i,e);n=Math.min(n,e)});_.bar_N=t.scale.linear().range([0,e]).domain([Math.min(0,r),a]);_.bar_S=t.scale.linear().range([0,e]).domain([0,i]);_.bar_SP=t.scale.linear().range([0,e]).domain([0,1]);_.bar_C=t.scale.linear().range([0,e]).domain([-a,a])};y.N=function(t){var e=_.bar_N;t.attr("width",function(t){return Math.abs(e(t.value)-e(0))}).attr("height",_.group_N.rangeBand()).attr("x",function(t){return e(Math.min(0,t.value))}).attr("y",function(t,e){var r=_.group_N(b[t.key].index);if(r!==undefined)return r;return this.getAttribute("y")})},y.S=function(t){var e=_.bar_S;t.attr("width",function(t){return e(t.value)}).attr("height",_.group.rangeBand()).attr("x",function(t){return e(t.cumx)}).attr("y",0)},y.SP=function(t){var e=_.bar_SP;t.attr("width",function(t){return e(t.percent)}).attr("height",_.group.rangeBand()).attr("x",function(t){return e(t.cumxp)}).attr("y",0)},y.C=function(t){var e=_.bar_C;t.attr("width",function(t){return e(t.value)-e(0)}).attr("height",_.group.rangeBand()).attr("x",function(t,r){return b[t.key].index%2==0?e(-t.value):e(0)}).attr("y",0)};var J=function(t){if(v){S.tickSize(-l,0);t.select(".h2d3_axis.y").call(S)}else{E.tickSize(-o,0);t.select(".h2d3_axis.x").call(E)}};var K=function(e){p=e;k.map(function(t){var r=0;t.series.map(function(t){if(e.indexOf(t.key)>-1&&!t.hasOwnProperty("hvalue")){t.hvalue=t.value;t.value=0}else if(e.indexOf(t.key)==-1&&t.hasOwnProperty("hvalue")){t.value=t.hvalue;delete t.hvalue}r+=t.value});if(r==0)r=1;t.total=r});k.forEach(function(t){j(t)});I();var r=t.range(w);p.forEach(function(t){r.splice(r.indexOf(b[t].index),1)});_.group_N.domain(r);Q()};var L=function(t){if(f==t)return;f=t;Q()};var Q=function(){var e=A.transition().duration(500);var r=_["bar_"+f];if(v){r=r.copy();r.range([o,0])}var a=v?S:E;a.scale(r);h=d;if(f=="SP")h=t.format(".2p");else if(f=="C")h=function(t){return d(Math.abs(t))};a.tickFormat(h);e.select(v?".y.h2d3_axis":".x.h2d3_axis").call(a);var n=y[f];e.selectAll(".h2d3_group rect.h2d3_bar").call(n)};var T=function(t){if(t==""||t[0]!="-"){e=1}else{var e=-1;t=t.slice(1)}if(t==""){for(var r in b){if(b.hasOwnProperty(r)){b[r].index=b[r].initial}}k.forEach(function(t){t.series.sort(function(t,e){return b[t.key].index-b[e.key].index});j(t)});k.sort(function(t,e){return t.initial-e.initial})}else{var a=-1;var n=null;for(var r in b){if(b.hasOwnProperty(r)){if(b[r].index==0)n=b[r];if(r==t){a=b[r].index;b[r].index=0}}}if(a==-1)console.error("serie not found : ",t);if(n!=null)n.index=a;k.forEach(function(t){t.series.sort(function(t,e){return b[t.key].index-b[e.key].index});j(t)});var i=f=="SP"?"percent":"value";k.sort(function(r,a){var n=r.series[0].key==t?r.series[0][i]:0;var l=a.series[0].key==t?a.series[0][i]:0;return e*(n-l)})}_.group=_.group.domain(k.map(function(t){return t.label})).copy();var l=(v?E:S).scale(_.group);var o=A.transition().duration(500);o.select(v?".h2d3_axis.x":".h2d3_axis.y").delay(500).call(l);if(N){A.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end")}o.selectAll(".h2d3_group").attr("transform",function(t){return"translate(0,"+_.group(t.label)+")"}).delay(500);var s=y[f];o.selectAll(".h2d3_group rect.h2d3_bar").call(s)};var U=function(t){var e={};var r=[];var a=[];t.forEach(function(t,a){var n={key:t.key,index:a,initial:a};var i=0;t.values.forEach(function(a,n){if(!e.hasOwnProperty(a.label)){var l=r.length;e[a.label]={label:a.label,series:[],initial:l};r.push(e[a.label])}e[a.label].series.push({key:t.key,value:a.value});i+=a.value;if(a.value<0)C=true});if(i==0)i=1;n.total=i;b[t.key]=n});e=null;console.log(r);return r};return O};return r});