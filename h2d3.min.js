(function(){var t=window.h2d3||{};window.h2d3=t;t.modeNames={N:"Normal",S:"Stacked",SP:"Percent",C:"Center"};t.styles={"default":["#a6cee3","#ff7f00","#b2df8a","#1f78b4","#fdbf6f","#33a02c","#cab2d6","#6a3d9a","#fb9a99","#e31a1c","#ffff99","#b15928"],pastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"],darkpastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"]};t.chart=function(){var e=600;var r=400;var a=600;var n=400;var i={top:20,right:20,bottom:20,left:20,axis:5};var l=["N","S","SP","C"];var s=[];var o="";var u=d3.format();var c=u;var d=false;var f=true;var h=[];var g="";var v={};var p={};var m={};var _=null;var x=0;var y=null;var b=null;var k=false;var w,B;var C=false;var A="default";var S=d3.hasOwnProperty("tip");var P=null;function E(f,h){x=h.length;_=J(h);var b=h.map(function(t){return t.key});a=e;n=r-i.bottom;var Z=[];for(var j=0;j<l.length;j++){if(!(x!=2&&l[j]=="C")&&!(k&&l[j]!="N")&&s.indexOf(l[j])==-1){Z.push(l[j])}}if(o=="")o=Z[0];else if(Z.indexOf(o)==-1){if(k)console.log("h2d3 : mode "+t.modeNames[o]+" not compatible with data (negatives values)");else console.log("h2d3 : mode "+t.modeNames[o]+" not compatible with data");o=Z[0]}y=d3.select(f).append("svg").attr("class","h2d3 "+A).attr("width",a).attr("height",n+i.bottom).append("g");N(Z);var H=y.select(".h2d3_controls")[0][0].getBBox();var K=d3.scale.ordinal().domain(d3.range(x)).range(t.styles[A]);v={color:K};M(b,H.width);var L=y.select(".h2d3_legend")[0][0].getBBox();var Q=Math.max(L.height,H.height);y.select(".h2d3_controls").attr("transform","translate(0,-"+Q+")");i.top=i.top+Q;n=n-i.top-i.bottom-i.axis;var T=y.append("g");var U=T.append("g");c=u;if(o=="SP")c=d3.format(".2p");else if(o=="C")c=function(t){return u(Math.abs(t))};B=V();T.append("g").attr("class","h2d3_axis y "+A).call(B).attr("transform","translate(-"+i.axis+",0)");var W=y.select(".h2d3_axis.y")[0][0].getBBox().width;a=a-(i.left+W)-i.right-i.axis;y.attr("transform","translate("+i.left+","+i.top+")");T.attr("transform","translate("+(i.axis+W)+",0)");w=z();T.append("g").attr("class","h2d3_axis x "+A).attr("transform","translate(0,"+(n+i.axis)+")").call(w);var X=R(w);if(X>0){n=n-X;B=V();T.select(".h2d3_axis.y").call(B);T.select(".h2d3_axis.x").attr("transform","translate(0,"+(n+i.axis)+")");C=true}T.insert("rect",":first-child").attr("width",a+i.axis).attr("height",n+i.axis).attr("x",-i.axis).attr("y",0).attr("class","h2d3_gridbg "+A);if(d){U.attr("transform","rotate(-90) translate(-"+n+",0)")}if(S){O();U.call(P)}var Y=U.selectAll(".h2d3_group").data(_).enter().append("g").attr("class","h2d3_group").attr("transform",function(t){return"translate(0,"+v.group(t.label)+")"});var $=p[o];var te=Y.selectAll(".h2d3_bar").data(function(t){t.series.sort(function(t,e){return m[t.key].index-m[e.key].index});F(t);return t.series}).enter().append("rect").attr("class",function(t){return"h2d3_bar h2d3_serie_"+D(t.key)}).attr("fill",function(t){return K(m[t.key].index)}).call($);if(S){te.on("mouseover",P.show).on("mouseout",P.hide)}if(g!=""){I(g)}E.sort=I;E.changeMode=G;E.hide=q}E.vertical=function(t){if(!arguments.length||t)d=true;return E};E.width=function(t){if(!arguments.length)return e;e=t;return E};E.height=function(t){if(!arguments.length)return r;r=t;return E};E.tickFormat=function(t){if(!arguments.length)return u;if(typeof t=="string")t=d3.format(t);u=t;return E};E.selectSeries=function(t){if(!arguments.length)return f;f=t;return E};E.margin=function(t){if(!arguments.length)return i;i=t;return E};E.percentMode=function(t){if(!arguments.length){o="SP";return E}if(!arguments[0])s.push("SP");if(arguments.length>1&&arguments[1])o="SP";return E};E.stackedMode=function(t){if(!arguments.length){o="S";return E}if(!arguments[0])s.push("S");if(arguments.length>1&&arguments[1])o="S";return E};E.normalMode=function(t){if(!arguments.length){o="N";return E}if(!arguments[0])s.push("N");if(arguments.length>1&&arguments[1])o="N";return E};E.centerMode=function(t){if(!arguments.length){o="C";return E}if(!arguments[0])s.push("C");if(arguments.length>1&&arguments[1])o="C";return E};E.sort=function(t){if(!arguments.length)return g;g=t;return E};E.style=function(e){if(!arguments.length)return A;if(t.styles.hasOwnProperty(e))A=e;return E};var N=function(e){var r=e.length>1?e:[];y.append("g").attr("class","h2d3_controls").selectAll("g").data(r).enter().append("g").attr("class","h2d3_ctrl "+A).style("cursor","pointer").attr("pointer-events","all").attr("transform",function(t,e){return"translate(0,"+e*16+")"}).each(function(e,r){var a=d3.select(this);a.append("circle").attr("class","h2d3_ctrl_circle "+A).attr("r","5");a.append("circle").attr("class",function(){if(e==o)return"h2d3_ctrl_dot h2d3_ctrl_dot_selected "+A;else return"h2d3_ctrl_dot "+A}).attr("r","2");a.append("text").attr("class","h2d3_ctrl_text").attr("dy",".32em").attr("dx","8").attr("text-anchor","start").text(function(){return t.modeNames[e]})}).on("click",function(t){if(t!=o){var e=d3.select(this.parentNode).selectAll(".h2d3_ctrl_dot_selected").attr("class","h2d3_ctrl_dot "+A);G(t);d3.select(this).selectAll(".h2d3_ctrl_dot").attr("class","h2d3_ctrl_dot h2d3_ctrl_dot_selected "+A)}})};var M=function(t,r){var a=20;var n=5;function l(t){var e=window.getComputedStyle(t,null).getPropertyValue("fill");d3.select(t).attr("stroke",e).attr("stroke-width","2.5").attr("fill","none").attr("class","h2d3_legend_item_circle")}function s(t){var e=window.getComputedStyle(t,null).getPropertyValue("stroke");d3.select(t).attr("stroke","none").attr("stroke-width","0.5").attr("fill",e)}y.append("g").attr("class","h2d3_legend").selectAll("g").data(t).enter().append("g").attr("class","h2d3_legend_item").style("cursor",f?"pointer":"auto").attr("pointer-events","all").each(function(t,e){var r=d3.select(this);r.append("circle").attr("class",function(){return"h2d3_legend_item_circle h2d3_serie_"+D(t)}).attr("fill",function(t){return v.color(m[t].index)}).attr("stroke-width","0.5").attr("stroke","none").attr("r","5");r.append("text").attr("class",function(){return"h2d3_legend_item_text h2d3_serie_"+D(t)}).attr("dy",".32em").attr("dx","8").attr("text-anchor","start").attr("fill",function(t){return v.color(m[t].index)}).text(function(){return t})}).on("click",function(t){if(!f)return;if(h.indexOf(t)==-1){h.push(t);q(h);l(this.getElementsByClassName("h2d3_legend_item_circle")[0])}else{var e=h.indexOf(t);h.splice(e,1);q(h);s(this.getElementsByClassName("h2d3_legend_item_circle")[0])}});var o=y.select(".h2d3_legend")[0][0].getBBox().width+n;var u=1;while(Math.ceil(x/u)*o>e-r-a&&u<x)u++;y.selectAll(".h2d3_legend_item").attr("transform",function(t,e){return"translate("+Math.floor(e/u)*o+","+e%u*16+")"});y.select(".h2d3_legend").attr("transform",function(t,r){return"translate("+(e-i.left-i.right-o*Math.ceil(x/u))+",-"+u*16+")"})};var O=function(){P=d3.tip().attr("class","h2d3-tip "+A).offset([-10,0]).direction("n").html(function(t){var e=o=="SP"?t.percent:t.value;return' <span style="color:'+v.color(m[t.key].index)+'">'+t.key+'</span><span class="h2d3-tip_text '+A+'" > : '+c(e)+"</span>"});if(d){P.offset(function(t){var e=this.getAttribute("height");var r=this.getAttribute("width");return[-r/2-10,e/2]})}return P};function D(t){return t.replace(/[^A-Za-z0-9]/g,"-")}function F(t){var e=0;var r=0;t.series.forEach(function(a){a.cumx=e;a.cumxp=r;a.percent=a.value/t.total;e+=a.value;r+=a.percent})}var R=function(t){var e=t.scale();if(d){var r=e.rangeBand();var a=0;y.select(".h2d3_axis.x").selectAll("text").each(function(){a=Math.max(this.getBBox().width,a)});if(a<r)return 0;y.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end").attr("transform","rotate(-30)");return y.select(".h2d3_axis.x")[0][0].getBBox().height}return 0};var V=function(){var t=d3.svg.axis();var e;if(d){j();e=v["bar_"+o].copy();e.range([n,0]);t.tickFormat(c)}else{Z();e=v.group}t.scale(e).orient("left");return t};var z=function(){var t=d3.svg.axis();if(d){Z();e=v.group}else{j();var e=v["bar_"+o];t.tickFormat(c)}t.scale(e).orient("bottom");return t};var Z=function(){var t=d?a:n;v.group=d3.scale.ordinal().domain(_.map(function(t){return t.label})).rangeRoundBands([0,t],.1);v.group_N=d3.scale.ordinal().domain(d3.range(x-h.length)).rangeRoundBands([0,v.group.rangeBand()])};var j=function(){var t=d?n:a;var e=999999999;var r=-999999999;var i=e;var l=r;_.forEach(function(t){var a=0;t.series.forEach(function(t,n){var i=t.value;e=Math.min(i,e);r=Math.max(i,r);a+=i;if(m[t.key].total>0)t.norm_value=i/m[t.key].total});t.total=a;l=Math.max(l,a);i=Math.min(i,a)});v.bar_N=d3.scale.linear().range([0,t]).domain([Math.min(0,e),r]);v.bar_S=d3.scale.linear().range([0,t]).domain([0,l]);v.bar_SP=d3.scale.linear().range([0,t]).domain([0,1]);v.bar_C=d3.scale.linear().range([0,t]).domain([-r,r])};p.N=function(t){var e=v.bar_N;t.attr("width",function(t){return Math.abs(e(t.value)-e(0))}).attr("height",v.group_N.rangeBand()).attr("x",function(t){return e(Math.min(0,t.value))}).attr("y",function(t,e){return v.group_N(m[t.key].index)})},p.S=function(t){var e=v.bar_S;t.attr("width",function(t){return e(t.value)}).attr("height",v.group.rangeBand()).attr("x",function(t){return e(t.cumx)}).attr("y",0)},p.SP=function(t){var e=v.bar_SP;t.attr("width",function(t){return e(t.percent)}).attr("height",v.group.rangeBand()).attr("x",function(t){return e(t.cumxp)}).attr("y",0)},p.C=function(t){var e=v.bar_C;t.attr("width",function(t){return e(t.value)-e(0)}).attr("height",v.group.rangeBand()).attr("x",function(t,r){return m[t.key].index%2==0?e(-t.value):e(0)}).attr("y",0)};var q=function(t){h=t;_.map(function(e){var r=0;e.series.map(function(e){if(t.indexOf(e.key)>-1&&!e.hasOwnProperty("hvalue")){e.hvalue=e.value;e.value=0}else if(t.indexOf(e.key)==-1&&e.hasOwnProperty("hvalue")){e.value=e.hvalue;delete e.hvalue}r+=e.value});if(r==0)r=1;e.total=r});_.forEach(function(t){F(t)});j();H()};var G=function(t){if(o==t)return;o=t;H()};var H=function(){var t=y.transition().duration(500);var e=v["bar_"+o];if(d){e=e.copy();e.range([n,0])}var r=d3.svg.axis().scale(e).orient(d?"left":"bottom");c=u;if(o=="SP")c=d3.format(".2p");else if(o=="C")c=function(t){return u(Math.abs(t))};r.tickFormat(c);t.select(d?".y.h2d3_axis":".x.h2d3_axis").call(r);var a=p[o];t.selectAll(".h2d3_group rect.h2d3_bar").call(a)};var I=function(t){if(t==""||t[0]!="-"){e=1}else{var e=-1;t=t.slice(1)}if(t==""){for(var r in m){if(m.hasOwnProperty(r)){m[r].index=m[r].initial}}_.forEach(function(t){t.series.sort(function(t,e){return m[t.key].index-m[e.key].index});F(t)});_.sort(function(t,e){return t.initial-e.initial})}else{var a=-1;var n=null;for(var r in m){if(m.hasOwnProperty(r)){if(m[r].index==0)n=m[r];if(r==t){a=m[r].index;m[r].index=0}}}if(a==-1)console.error("serie not found : ",t);if(n!=null)n.index=a;_.forEach(function(t){t.series.sort(function(t,e){return m[t.key].index-m[e.key].index});F(t)});var i=o=="SP"?"percent":"value";_.sort(function(r,a){var n=r.series[0].key==t?r.series[0][i]:0;var l=a.series[0].key==t?a.series[0][i]:0;return e*(n-l)})}v.group=v.group.domain(_.map(function(t){return t.label})).copy();var l=(d?w:B).scale(v.group);var s=y.transition().duration(500);s.select(d?".h2d3_axis.x":".h2d3_axis.y").delay(500).call(l);if(C){y.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end")}s.selectAll(".h2d3_group").attr("transform",function(t){return"translate(0,"+v.group(t.label)+")"}).delay(500);var u=p[o];s.selectAll(".h2d3_group rect.h2d3_bar").call(u)};var J=function(t){var e={};var r=[];t.forEach(function(t,a){var n={key:t.key,index:a,initial:a};var i=0;t.values.forEach(function(a,n){if(!e.hasOwnProperty(a.label)){var l=r.length;e[a.label]={label:a.label,series:[],initial:l};r.push(e[a.label])}e[a.label].series.push({key:t.key,value:a.value});i+=a.value;if(a.value<0)k=true});if(i==0)i=1;n.total=i;m[t.key]=n});e=null;return r};return E}})();