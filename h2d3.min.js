(function(){var t=window.h2d3||{};window.h2d3=t;t.modeNames={N:"Normal",S:"Stacked",SP:"Percent",C:"Center"};t.styles={"default":["#a6cee3","#ff7f00","#b2df8a","#1f78b4","#fdbf6f","#33a02c","#cab2d6","#6a3d9a","#fb9a99","#e31a1c","#ffff99","#b15928"],pastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"],darkpastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"],colorblind:["#999999","#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7"]};t.chart=function(){var e=600;var r=400;var a=600;var n=400;var i={top:20,right:20,bottom:20,left:20,axis:5};var l=["N","S","SP","C"];var s=[];var o="";var u=d3.format();var c=u;var d=false;var f=true;var h=[];var v="";var g={};var p={};var m={};var x=null;var _=0;var y=null;var b=null;var k=false;var w,B;var C=false;var A="default";var E=d3.hasOwnProperty("tip");var S=null;function P(f,h){_=h.length;x=K(h);var b=h.map(function(t){return t.key});a=e;n=r-i.bottom;var Z=[];for(var j=0;j<l.length;j++){if(!(_!=2&&l[j]=="C")&&!(k&&l[j]!="N")&&s.indexOf(l[j])==-1){Z.push(l[j])}}if(o=="")o=Z[0];else if(Z.indexOf(o)==-1){if(k)console.log("h2d3 : mode "+t.modeNames[o]+" not compatible with data (negatives values)");else console.log("h2d3 : mode "+t.modeNames[o]+" not compatible with data");o=Z[0]}y=d3.select(f).append("svg").attr("class","h2d3 "+A).attr("width",a).attr("height",n+i.bottom).append("g");N(Z);var I=y.select(".h2d3_controls")[0][0].getBBox();var L=d3.scale.ordinal().domain(d3.range(_)).range(t.styles[A]);g={color:L};M(b,I.width);var Q=y.select(".h2d3_legend")[0][0].getBBox();var T=Math.max(Q.height,I.height);y.select(".h2d3_controls").attr("transform","translate(0,-"+T+")");i.top=i.top+T;n=n-i.top-i.bottom-i.axis;var U=y.append("g");var W=U.append("g");c=u;if(o=="SP")c=d3.format(".2p");else if(o=="C")c=function(t){return u(Math.abs(t))};B=V();U.append("g").attr("class","h2d3_axis y "+A).call(B).attr("transform","translate(-"+i.axis+",0)");var X=y.select(".h2d3_axis.y")[0][0].getBBox().width;a=a-(i.left+X)-i.right-i.axis;y.attr("transform","translate("+i.left+","+i.top+")");U.attr("transform","translate("+(i.axis+X)+",0)");w=z();U.append("g").attr("class","h2d3_axis x "+A).attr("transform","translate(0,"+(n+i.axis)+")").call(w);var Y=R(w);if(Y>0){n=n-Y;B=V();U.select(".h2d3_axis.y").call(B);U.select(".h2d3_axis.x").attr("transform","translate(0,"+(n+i.axis)+")");C=true}U.insert("rect",":first-child").attr("width",a+i.axis).attr("height",n+i.axis).attr("x",-i.axis).attr("y",0).attr("class","h2d3_gridbg "+A);W.selectAll("h2d3_grid").call(q);if(d){W.attr("transform","rotate(-90) translate(-"+n+",0)")}if(E){O();W.call(S)}var $=W.selectAll(".h2d3_group").data(x).enter().append("g").attr("class","h2d3_group").attr("transform",function(t){return"translate(0,"+g.group(t.label)+")"});var te=p[o];var ee=$.selectAll(".h2d3_bar").data(function(t){t.series.sort(function(t,e){return m[t.key].index-m[e.key].index});F(t);return t.series}).enter().append("rect").attr("class",function(t){return"h2d3_bar h2d3_serie_"+D(t.key)}).attr("fill",function(t){return L(m[t.key].index)}).call(te);if(E){ee.on("mouseover",S.show).on("mouseout",S.hide)}if(v!=""){J(v)}P.sort=J;P.changeMode=H;P.hide=G}P.vertical=function(t){if(!arguments.length||t)d=true;return P};P.width=function(t){if(!arguments.length)return e;e=t;return P};P.height=function(t){if(!arguments.length)return r;r=t;return P};P.tickFormat=function(t){if(!arguments.length)return u;if(typeof t=="string")t=d3.format(t);u=t;return P};P.selectSeries=function(t){if(!arguments.length)return f;f=t;return P};P.margin=function(t){if(!arguments.length)return i;i=t;return P};P.percentMode=function(t){if(!arguments.length){o="SP";return P}if(!arguments[0])s.push("SP");if(arguments.length>1&&arguments[1])o="SP";return P};P.stackedMode=function(t){if(!arguments.length){o="S";return P}if(!arguments[0])s.push("S");if(arguments.length>1&&arguments[1])o="S";return P};P.normalMode=function(t){if(!arguments.length){o="N";return P}if(!arguments[0])s.push("N");if(arguments.length>1&&arguments[1])o="N";return P};P.centerMode=function(t){if(!arguments.length){o="C";return P}if(!arguments[0])s.push("C");if(arguments.length>1&&arguments[1])o="C";return P};P.sort=function(t){if(!arguments.length)return v;v=t;return P};P.style=function(e){if(!arguments.length)return A;if(t.styles.hasOwnProperty(e))A=e;return P};var N=function(e){var r=e.length>1?e:[];y.append("g").attr("class","h2d3_controls").selectAll("g").data(r).enter().append("g").attr("class","h2d3_ctrl "+A).style("cursor","pointer").attr("pointer-events","all").attr("transform",function(t,e){return"translate(0,"+e*16+")"}).each(function(e,r){var a=d3.select(this);a.append("circle").attr("class","h2d3_ctrl_circle "+A).attr("r","5");a.append("circle").attr("class",function(){if(e==o)return"h2d3_ctrl_dot h2d3_ctrl_dot_selected "+A;else return"h2d3_ctrl_dot "+A}).attr("r","2");a.append("text").attr("class","h2d3_ctrl_text").attr("dy",".32em").attr("dx","8").attr("text-anchor","start").text(function(){return t.modeNames[e]})}).on("click",function(t){if(t!=o){var e=d3.select(this.parentNode).selectAll(".h2d3_ctrl_dot_selected").attr("class","h2d3_ctrl_dot "+A);H(t);d3.select(this).selectAll(".h2d3_ctrl_dot").attr("class","h2d3_ctrl_dot h2d3_ctrl_dot_selected "+A)}})};var M=function(t,r){var a=20;var n=5;function l(t){var e=window.getComputedStyle(t,null).getPropertyValue("fill");d3.select(t).attr("stroke",e).attr("stroke-width","2.5").attr("fill","none").attr("class","h2d3_legend_item_circle")}function s(t){var e=window.getComputedStyle(t,null).getPropertyValue("stroke");d3.select(t).attr("stroke","none").attr("stroke-width","0.5").attr("fill",e)}y.append("g").attr("class","h2d3_legend").selectAll("g").data(t).enter().append("g").attr("class","h2d3_legend_item").style("cursor",f?"pointer":"auto").attr("pointer-events","all").each(function(t,e){var r=d3.select(this);r.append("circle").attr("class",function(){return"h2d3_legend_item_circle h2d3_serie_"+D(t)}).attr("fill",function(t){return g.color(m[t].index)}).attr("stroke-width","0.5").attr("stroke","none").attr("r","5");r.append("text").attr("class",function(){return"h2d3_legend_item_text h2d3_serie_"+D(t)}).attr("dy",".32em").attr("dx","8").attr("text-anchor","start").attr("fill",function(t){return g.color(m[t].index)}).text(function(){return t})}).on("click",function(t){if(!f)return;if(h.indexOf(t)==-1){h.push(t);G(h);l(this.getElementsByClassName("h2d3_legend_item_circle")[0])}else{var e=h.indexOf(t);h.splice(e,1);G(h);s(this.getElementsByClassName("h2d3_legend_item_circle")[0])}});var o=y.select(".h2d3_legend")[0][0].getBBox().width+n;var u=1;while(Math.ceil(_/u)*o>e-r-a&&u<_)u++;y.selectAll(".h2d3_legend_item").attr("transform",function(t,e){return"translate("+Math.floor(e/u)*o+","+e%u*16+")"});y.select(".h2d3_legend").attr("transform",function(t,r){return"translate("+(e-i.left-i.right-o*Math.ceil(_/u))+",-"+u*16+")"})};var O=function(){S=d3.tip().attr("class","h2d3-tip "+A).offset([-10,0]).direction("n").html(function(t){var e=o=="SP"?t.percent:t.value;return' <span style="color:'+g.color(m[t.key].index)+'">'+t.key+'</span><span class="h2d3-tip_text '+A+'" > : '+c(e)+"</span>"});if(d){S.offset(function(t){var e=this.getAttribute("height");var r=this.getAttribute("width");return[-r/2-10,e/2]})}return S};function D(t){return t.replace(/[^A-Za-z0-9]/g,"-")}function F(t){var e=0;var r=0;t.series.forEach(function(a){a.cumx=e;a.cumxp=r;a.percent=a.value/t.total;e+=a.value;r+=a.percent})}var R=function(t){var e=t.scale();if(d){var r=e.rangeBand();var a=0;y.select(".h2d3_axis.x").selectAll("text").each(function(){a=Math.max(this.getBBox().width,a)});if(a<r)return 0;y.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end").attr("transform","rotate(-30)");return y.select(".h2d3_axis.x")[0][0].getBBox().height}return 0};var V=function(){var t=d3.svg.axis();var e;if(d){j();e=g["bar_"+o].copy();e.range([n,0]);t.tickFormat(c)}else{Z();e=g.group}t.scale(e).orient("left");return t};var z=function(){var t=d3.svg.axis();if(d){Z();e=g.group}else{j();var e=g["bar_"+o];t.tickFormat(c)}t.scale(e).orient("bottom");return t};var Z=function(){var t=d?a:n;g.group=d3.scale.ordinal().domain(x.map(function(t){return t.label})).rangeRoundBands([0,t],.1);g.group_N=d3.scale.ordinal().domain(d3.range(_)).rangeRoundBands([0,g.group.rangeBand()])};var j=function(){var t=d?n:a;var e=999999999;var r=-999999999;var i=e;var l=r;x.forEach(function(t){var a=0;t.series.forEach(function(t,n){var i=t.value;e=Math.min(i,e);r=Math.max(i,r);a+=i;if(m[t.key].total>0)t.norm_value=i/m[t.key].total});t.total=a;l=Math.max(l,a);i=Math.min(i,a)});g.bar_N=d3.scale.linear().range([0,t]).domain([Math.min(0,e),r]);g.bar_S=d3.scale.linear().range([0,t]).domain([0,l]);g.bar_SP=d3.scale.linear().range([0,t]).domain([0,1]);g.bar_C=d3.scale.linear().range([0,t]).domain([-r,r])};p.N=function(t){var e=g.bar_N;t.attr("width",function(t){return Math.abs(e(t.value)-e(0))}).attr("height",g.group_N.rangeBand()).attr("x",function(t){return e(Math.min(0,t.value))}).attr("y",function(t,e){var r=g.group_N(m[t.key].index);if(r!==undefined)return r;return this.getAttribute("y")})},p.S=function(t){var e=g.bar_S;t.attr("width",function(t){return e(t.value)}).attr("height",g.group.rangeBand()).attr("x",function(t){return e(t.cumx)}).attr("y",0)},p.SP=function(t){var e=g.bar_SP;t.attr("width",function(t){return e(t.percent)}).attr("height",g.group.rangeBand()).attr("x",function(t){return e(t.cumxp)}).attr("y",0)},p.C=function(t){var e=g.bar_C;t.attr("width",function(t){return e(t.value)-e(0)}).attr("height",g.group.rangeBand()).attr("x",function(t,r){return m[t.key].index%2==0?e(-t.value):e(0)}).attr("y",0)};var q=function(t){var e=d?a:n;var r=g["bar_"+o];t.data(r.ticks(10)).enter().append("line").attr("class","h2d3_grid "+A).attr("y1",d?-i.axis:0).attr("y2",d?e:e+i.axis).attr("x1",function(t){return r(t)}).attr("x2",function(t){return r(t)})};var G=function(t){h=t;x.map(function(e){var r=0;e.series.map(function(e){if(t.indexOf(e.key)>-1&&!e.hasOwnProperty("hvalue")){e.hvalue=e.value;e.value=0}else if(t.indexOf(e.key)==-1&&e.hasOwnProperty("hvalue")){e.value=e.hvalue;delete e.hvalue}r+=e.value});if(r==0)r=1;e.total=r});x.forEach(function(t){F(t)});j();var e=d3.range(_);h.forEach(function(t){e.splice(e.indexOf(m[t].index),1)});g.group_N.domain(e);I()};var H=function(t){if(o==t)return;o=t;I()};var I=function(){var t=y.transition().duration(500);var e=g["bar_"+o];if(d){e=e.copy();e.range([n,0])}var r=d3.svg.axis().scale(e).orient(d?"left":"bottom");c=u;if(o=="SP")c=d3.format(".2p");else if(o=="C")c=function(t){return u(Math.abs(t))};r.tickFormat(c);t.select(d?".y.h2d3_axis":".x.h2d3_axis").call(r);var a=p[o];t.selectAll(".h2d3_group rect.h2d3_bar").call(a)};var J=function(t){if(t==""||t[0]!="-"){e=1}else{var e=-1;t=t.slice(1)}if(t==""){for(var r in m){if(m.hasOwnProperty(r)){m[r].index=m[r].initial}}x.forEach(function(t){t.series.sort(function(t,e){return m[t.key].index-m[e.key].index});F(t)});x.sort(function(t,e){return t.initial-e.initial})}else{var a=-1;var n=null;for(var r in m){if(m.hasOwnProperty(r)){if(m[r].index==0)n=m[r];if(r==t){a=m[r].index;m[r].index=0}}}if(a==-1)console.error("serie not found : ",t);if(n!=null)n.index=a;x.forEach(function(t){t.series.sort(function(t,e){return m[t.key].index-m[e.key].index});F(t)});var i=o=="SP"?"percent":"value";x.sort(function(r,a){var n=r.series[0].key==t?r.series[0][i]:0;var l=a.series[0].key==t?a.series[0][i]:0;return e*(n-l)})}g.group=g.group.domain(x.map(function(t){return t.label})).copy();var l=(d?w:B).scale(g.group);var s=y.transition().duration(500);s.select(d?".h2d3_axis.x":".h2d3_axis.y").delay(500).call(l);if(C){y.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end")}s.selectAll(".h2d3_group").attr("transform",function(t){return"translate(0,"+g.group(t.label)+")"}).delay(500);var u=p[o];s.selectAll(".h2d3_group rect.h2d3_bar").call(u)};var K=function(t){var e={};var r=[];t.forEach(function(t,a){var n={key:t.key,index:a,initial:a};var i=0;t.values.forEach(function(a,n){if(!e.hasOwnProperty(a.label)){var l=r.length;e[a.label]={label:a.label,series:[],initial:l};r.push(e[a.label])}e[a.label].series.push({key:t.key,value:a.value});i+=a.value;if(a.value<0)k=true});if(i==0)i=1;n.total=i;m[t.key]=n});e=null;return r};return P}})();