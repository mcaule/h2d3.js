(function(){var t=window.h2d3||{};window.h2d3=t;t.modeNames={N:"Normal",S:"Stacked",SP:"Percent",C:"Center"};t.styles={"default":["#a6cee3","#ff7f00","#b2df8a","#1f78b4","#fdbf6f","#33a02c","#cab2d6","#6a3d9a","#fb9a99","#e31a1c","#ffff99","#b15928"],pastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"],darkpastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"]};t.chart=function(){var e=600;var r=400;var a=600;var n=400;var i={top:20,right:20,bottom:20,left:20,axis:5};var l=["N","S","SP","C"];var s=[];var o="";var u=d3.format();var c=false;var d=true;var f=[];var h="";var g={};var v={};var m={};var p=null;var _=0;var x=null;var y=null;var b=false;var k,B;var C=false;var w="default";function A(d,f){_=f.length;p=q(f);var y=f.map(function(t){return t.key});a=e;n=r-i.bottom;var F=[];for(var R=0;R<l.length;R++){if(!(_!=2&&l[R]=="C")&&!(b&&l[R]!="N")&&s.indexOf(l[R])==-1){F.push(l[R])}}if(o=="")o=F[0];else if(F.indexOf(o)==-1){if(b)console.log("h2d3 : mode "+t.modeNames[o]+" not compatible with data (negatives values)");else console.log("h2d3 : mode "+t.modeNames[o]+" not compatible with data");o=F[0]}x=d3.select(d).append("svg").attr("class","h2d3 "+w).attr("width",a).attr("height",n+i.bottom).append("g");S(F);var Z=x.select(".h2d3_controls")[0][0].getBBox();var G=d3.scale.ordinal().domain(d3.range(_)).range(t.styles[w]);g={color:G};E(y,Z.width);var H=x.select(".h2d3_legend")[0][0].getBBox();var I=Math.max(H.height,Z.height);x.select(".h2d3_controls").attr("transform","translate(0,-"+I+")");i.top=i.top+I;n=n-i.top-i.bottom-i.axis;var J=x.append("g");var K=J.append("g");var L=u;if(o=="SP")L=d3.format("p");else if(o=="C")L=function(t){return u(Math.abs(t))};B=D(L);J.append("g").attr("class","h2d3_axis y "+w).call(B).attr("transform","translate(-"+i.axis+",0)");var Q=x.select(".h2d3_axis.y")[0][0].getBBox().width;a=a-(i.left+Q)-i.right-i.axis;x.attr("transform","translate("+i.left+","+i.top+")");J.attr("transform","translate("+(i.axis+Q)+",0)");k=O(L);J.append("g").attr("class","h2d3_axis x "+w).attr("transform","translate(0,"+(n+i.axis)+")").call(k);var T=M(k);if(T>0){n=n-T;B=D(L);J.select(".h2d3_axis.y").call(B);J.select(".h2d3_axis.x").attr("transform","translate(0,"+(n+i.axis)+")");C=true}J.insert("rect",":first-child").attr("width",a+i.axis).attr("height",n+i.axis).attr("x",-i.axis).attr("y",0).attr("class","h2d3_gridbg "+w);if(c){K.attr("transform","rotate(-90) translate(-"+n+",0)")}var U=K.selectAll(".h2d3_group").data(p).enter().append("g").attr("class","h2d3_group").attr("transform",function(t){return"translate(0,"+g.group(t.label)+")"});var W=v[o];U.selectAll(".h2d3_bar").data(function(t){t.series.sort(function(t,e){return m[t.key].index-m[e.key].index});P(t);return t.series}).enter().append("rect").attr("class",function(t){return"h2d3_bar h2d3_serie_"+N(t.key)}).attr("fill",function(t){return G(m[t.key].index)}).call(W);if(h!=""){j(h)}A.sort=j;A.changeMode=z;A.hide=V}A.vertical=function(t){if(!arguments.length||t)c=true;return A};A.width=function(t){if(!arguments.length)return e;e=t;return A};A.height=function(t){if(!arguments.length)return r;r=t;return A};A.tickFormat=function(t){if(!arguments.length)return u;u=t;return A};A.selectSeries=function(t){if(!arguments.length)return d;d=t;return A};A.margin=function(t){if(!arguments.length)return i;i=t;return A};A.percentMode=function(t){if(!arguments.length){o="SP";return A}if(!arguments[0])s.push("SP");if(arguments.length>1&&arguments[1])o="SP";return A};A.stackedMode=function(t){if(!arguments.length){o="S";return A}if(!arguments[0])s.push("S");if(arguments.length>1&&arguments[1])o="S";return A};A.normalMode=function(t){if(!arguments.length){o="N";return A}if(!arguments[0])s.push("N");if(arguments.length>1&&arguments[1])o="N";return A};A.centerMode=function(t){if(!arguments.length){o="C";return A}if(!arguments[0])s.push("C");if(arguments.length>1&&arguments[1])o="C";return A};A.sort=function(t){if(!arguments.length)return h;h=t;return A};A.style=function(e){if(!arguments.length)return w;if(t.styles.hasOwnProperty(e))w=e;return A};var S=function(e){var r=e.length>1?e:[];x.append("g").attr("class","h2d3_controls").selectAll("g").data(r).enter().append("g").attr("class","h2d3_ctrl "+w).style("cursor","pointer").attr("transform",function(t,e){return"translate(0,"+e*16+")"}).each(function(e,r){var a=d3.select(this);a.append("circle").attr("class","h2d3_ctrl_circle "+w).attr("r","5");a.append("circle").attr("class",function(){if(e==o)return"h2d3_ctrl_dot h2d3_ctrl_dot_selected "+w;else return"h2d3_ctrl_dot "+w}).attr("r","2");a.append("text").attr("class","h2d3_ctrl_text").attr("dy",".32em").attr("dx","8").attr("text-anchor","start").text(function(){return t.modeNames[e]})}).on("click",function(t){if(t!=o){var e=d3.select(this.parentNode).selectAll(".h2d3_ctrl_dot_selected").attr("class","h2d3_ctrl_dot "+w);z(t);d3.select(this).selectAll(".h2d3_ctrl_dot").attr("class","h2d3_ctrl_dot h2d3_ctrl_dot_selected "+w)}})};var E=function(t,r){var a=20;var n=5;function l(t){var e=window.getComputedStyle(t,null).getPropertyValue("fill");d3.select(t).attr("stroke",e).attr("stroke-width","2.5").attr("fill","none").attr("class","h2d3_legend_item_circle")}function s(t){var e=window.getComputedStyle(t,null).getPropertyValue("stroke");d3.select(t).attr("stroke","none").attr("stroke-width","0.5").attr("fill",e)}x.append("g").attr("class","h2d3_legend").selectAll("g").data(t).enter().append("g").attr("class","h2d3_legend_item").style("cursor",d?"pointer":"auto").each(function(t,e){var r=d3.select(this);r.append("circle").attr("class",function(){return"h2d3_legend_item_circle h2d3_serie_"+N(t)}).attr("fill",function(t){return g.color(m[t].index)}).attr("stroke-width","0.5").attr("stroke","none").attr("r","5");r.append("text").attr("class",function(){return"h2d3_legend_item_text h2d3_serie_"+N(t)}).attr("dy",".32em").attr("dx","8").attr("text-anchor","start").attr("fill",function(t){return g.color(m[t].index)}).text(function(){return t})}).on("click",function(t){if(!d)return;if(f.indexOf(t)==-1){f.push(t);V(f);l(this.getElementsByClassName("h2d3_legend_item_circle")[0])}else{var e=f.indexOf(t);f.splice(e,1);V(f);s(this.getElementsByClassName("h2d3_legend_item_circle")[0])}});var o=x.select(".h2d3_legend")[0][0].getBBox().width+n;var u=1;while(Math.ceil(_/u)*o>e-r-a&&u<_)u++;x.selectAll(".h2d3_legend_item").attr("transform",function(t,e){return"translate("+Math.floor(e/u)*o+","+e%u*16+")"});x.select(".h2d3_legend").attr("transform",function(t,r){return"translate("+(e-i.left-i.right-o*Math.ceil(_/u))+",-"+u*16+")"})};function N(t){return t.replace(/[^A-Za-z0-9]/g,"-")}function P(t){var e=0;var r=0;t.series.forEach(function(a){a.cumx=e;a.cumxp=r;a.percent=a.value/t.total;e+=a.value;r+=a.percent})}var M=function(t){var e=t.scale();if(c){var r=e.rangeBand();var a=0;x.select(".h2d3_axis.x").selectAll("text").each(function(){a=Math.max(this.getBBox().width,a)});if(a<r)return 0;x.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end").attr("transform","rotate(-30)");return x.select(".h2d3_axis.x")[0][0].getBBox().height}return 0};var D=function(t){var e=d3.svg.axis();var r;if(c){R();r=g["bar_"+o].copy();r.range([n,0]);e.tickFormat(t)}else{F();r=g.group}e.scale(r).orient("left");return e};var O=function(t){var e=d3.svg.axis();if(c){F();r=g.group}else{R();var r=g["bar_"+o];e.tickFormat(t)}e.scale(r).orient("bottom");return e};var F=function(){var t=c?a:n;g.group=d3.scale.ordinal().domain(p.map(function(t){return t.label})).rangeRoundBands([0,t],.1);g.group_N=d3.scale.ordinal().domain(d3.range(_-f.length)).rangeRoundBands([0,g.group.rangeBand()])};var R=function(){var t=c?n:a;var e=999999999;var r=-999999999;var i=e;var l=r;p.forEach(function(t){var a=0;t.series.forEach(function(t,n){var i=t.value;e=Math.min(i,e);r=Math.max(i,r);a+=i;if(m[t.key].total>0)t.norm_value=i/m[t.key].total});t.total=a;l=Math.max(l,a);i=Math.min(i,a)});g.bar_N=d3.scale.linear().range([0,t]).domain([Math.min(0,e),r]);g.bar_S=d3.scale.linear().range([0,t]).domain([0,l]);g.bar_SP=d3.scale.linear().range([0,t]).domain([0,1]);g.bar_C=d3.scale.linear().range([0,t]).domain([-r,r])};v.N=function(t){var e=g.bar_N;t.attr("width",function(t){return Math.abs(e(t.value)-e(0))}).attr("height",g.group_N.rangeBand()).attr("x",function(t){return e(Math.min(0,t.value))}).attr("y",function(t,e){return g.group_N(m[t.key].index)})},v.S=function(t){var e=g.bar_S;t.attr("width",function(t){return e(t.value)}).attr("height",g.group.rangeBand()).attr("x",function(t){return e(t.cumx)}).attr("y",0)},v.SP=function(t){var e=g.bar_SP;t.attr("width",function(t){return e(t.percent)}).attr("height",g.group.rangeBand()).attr("x",function(t){return e(t.cumxp)}).attr("y",0)},v.C=function(t){var e=g.bar_C;t.attr("width",function(t){return e(t.value)-e(0)}).attr("height",g.group.rangeBand()).attr("x",function(t,r){return m[t.key].index%2==0?e(-t.value):e(0)}).attr("y",0)};var V=function(t){f=t;p.map(function(e){var r=0;e.series.map(function(e){if(t.indexOf(e.key)>-1&&!e.hasOwnProperty("hvalue")){e.hvalue=e.value;e.value=0}else if(t.indexOf(e.key)==-1&&e.hasOwnProperty("hvalue")){e.value=e.hvalue;delete e.hvalue}r+=e.value});if(r==0)r=1;e.total=r});p.forEach(function(t){P(t)});R();Z()};var z=function(t){if(o==t)return;o=t;Z()};var Z=function(){var t=x.transition().duration(500);var e=g["bar_"+o];if(c){e=e.copy();e.range([n,0])}var r=d3.svg.axis().scale(e).orient(c?"left":"bottom");if(o=="SP")r.tickFormat(d3.format("p"));else if(o=="C")r.tickFormat(function(t){return u(Math.abs(t))});else r.tickFormat(u);t.select(c?".y.h2d3_axis":".x.h2d3_axis").call(r);var a=v[o];t.selectAll(".h2d3_group rect.h2d3_bar").call(a)};var j=function(t){if(t==""||t[0]!="-"){e=1}else{var e=-1;t=t.slice(1)}if(t==""){for(var r in m){if(m.hasOwnProperty(r)){m[r].index=m[r].initial}}p.forEach(function(t){t.series.sort(function(t,e){return m[t.key].index-m[e.key].index});P(t)});p.sort(function(t,e){return t.initial-e.initial})}else{var a=-1;var n=null;for(var r in m){if(m.hasOwnProperty(r)){if(m[r].index==0)n=m[r];if(r==t){a=m[r].index;m[r].index=0}}}if(a==-1)console.error("serie not found : ",t);if(n!=null)n.index=a;p.forEach(function(t){t.series.sort(function(t,e){return m[t.key].index-m[e.key].index});P(t)});var i=o=="SP"?"percent":"value";p.sort(function(r,a){var n=r.series[0].key==t?r.series[0][i]:0;var l=a.series[0].key==t?a.series[0][i]:0;return e*(n-l)})}g.group=g.group.domain(p.map(function(t){return t.label})).copy();var l=(c?k:B).scale(g.group);var s=x.transition().duration(500);s.select(c?".h2d3_axis.x":".h2d3_axis.y").delay(500).call(l);if(C){x.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end")}s.selectAll(".h2d3_group").attr("transform",function(t){return"translate(0,"+g.group(t.label)+")"}).delay(500);var u=v[o];s.selectAll(".h2d3_group rect.h2d3_bar").call(u)};var q=function(t){var e={};var r=[];t.forEach(function(t,a){var n={key:t.key,index:a,initial:a};var i=0;t.values.forEach(function(a,n){if(!e.hasOwnProperty(a.label)){var l=r.length;e[a.label]={label:a.label,series:[],initial:l};r.push(e[a.label])}e[a.label].series.push({key:t.key,value:a.value});i+=a.value;if(a.value<0)b=true});if(i==0)i=1;n.total=i;m[t.key]=n});e=null;return r};return A}})();