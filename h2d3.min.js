(function(t){if(typeof define==="function"&&define.amd){define(["d3","d3-tip"],t)}else{if(d3&&d3.tip)window.h2d3=t(d3,d3.tip);else window.h2d3=t(d3)}})(function(t,e){var r={};var a=!(typeof e==="undefined");r.modeNames={N:"Normal",S:"Stacked",SP:"Percent",C:"Center"};r.styles={"default":["#a6cee3","#ff7f00","#b2df8a","#1f78b4","#fdbf6f","#33a02c","#cab2d6","#6a3d9a","#fb9a99","#e31a1c","#ffff99","#b15928"],pastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"],darkpastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"],colorblind:["#999999","#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7"]};r.chart=function(){var n=600;var i=400;var l=600;var s=400;var o={top:20,right:20,bottom:20,left:20,axis:5};var u=["N","S","SP","C"];var c=[];var f="";var d=t.format();var h=d;var g=false;var v=true;var p=[];var m="";var x=null;var _={};var y={};var b={};var k=null;var A=0;var B=null;var C=null;var w=false;var E,S;var N=false;var P="default";var M=null;function D(e,v){A=v.length;k=T(v);var p=v.map(function(t){return t.key});l=n;s=i-o.bottom;var C=[];for(var G=0;G<u.length;G++){if(!(A!=2&&u[G]=="C")&&!(w&&u[G]!="N")&&c.indexOf(u[G])==-1){C.push(u[G])}}if(f=="")f=C[0];else if(C.indexOf(f)==-1){if(w)console.log("h2d3 : mode "+r.modeNames[f]+" not compatible with data (negatives values)");else console.log("h2d3 : mode "+r.modeNames[f]+" not compatible with data");f=C[0]}B=t.select(e).append("svg").attr("class","h2d3 "+P).attr("width",l).attr("height",s+o.bottom).append("g");O(C);var H=B.select(".h2d3_controls")[0][0].getBBox();var L=t.scale.ordinal().domain(t.range(A));if(x==null)L.range(r.styles[P]);else L.range(x);_={color:L};F(p,H.width);var U=B.select(".h2d3_legend")[0][0].getBBox();var W=Math.max(U.height,H.height);B.select(".h2d3_controls").attr("transform","translate(0,-"+W+")");o.top=o.top+W;s=s-o.top-o.bottom-o.axis;var X=B.append("g");h=d;if(f=="SP")h=t.format(".2p");else if(f=="C")h=function(t){return d(Math.abs(t))};S=j();X.append("g").attr("class","h2d3_axis y "+P+" "+(g?"barAxis":"groupAxis")).call(S).attr("transform","translate(-"+o.axis+",0)");var Y=B.select(".h2d3_axis.y")[0][0].getBBox().width;l=l-(o.left+Y)-o.right-o.axis;B.attr("transform","translate("+o.left+","+o.top+")");X.attr("transform","translate("+(o.axis+Y)+",0)");E=q();X.append("g").attr("class","h2d3_axis x "+P+" "+(g?"groupAxis":"barAxis")).attr("transform","translate(0,"+(s+o.axis)+")").call(E);var $=Z(E);if($>0){s=s-$;S=j();X.select(".h2d3_axis.y").call(S);X.select(".h2d3_axis.x").attr("transform","translate(0,"+(s+o.axis)+")");N=true}X.insert("rect",":first-child").attr("width",l+o.axis).attr("height",s+o.axis).attr("x",-o.axis).attr("y",0).attr("class","h2d3_gridbg "+P);I(X);var te=X.append("g");if(g){te.attr("transform","rotate(-90) translate(-"+s+",0)")}if(a){z();te.call(M)}var ee=te.selectAll(".h2d3_group").data(k).enter().append("g").attr("class","h2d3_group").attr("transform",function(t){return"translate(0,"+_.group(t.label)+")"});var re=y[f];var ae=ee.selectAll(".h2d3_bar").data(function(t){t.series.sort(function(t,e){return b[t.key].index-b[e.key].index});V(t);return t.series}).enter().append("rect").attr("class",function(t){return"h2d3_bar h2d3_serie_"+R(t.key)}).attr("fill",function(t){return L(b[t.key].index)}).call(re);if(a){ae.on("mouseover",M.show).on("mouseout",M.hide)}if(m!=""){Q(m)}D.sort=Q;D.changeMode=K;D.hide=J}D.vertical=function(t){if(!arguments.length||t)g=true;return D};D.width=function(t){if(!arguments.length)return n;n=t;return D};D.height=function(t){if(!arguments.length)return i;i=t;return D};D.tickFormat=function(e){if(!arguments.length)return d;if(typeof e=="string")e=t.format(e);d=e;return D};D.selectSeries=function(t){if(!arguments.length)return v;v=t;return D};D.colors=function(t){if(!arguments.length)return x;x=t;return D};D.margin=function(t){if(!arguments.length)return o;o=t;return D};D.percentMode=function(t){if(!arguments.length){f="SP";return D}if(!arguments[0])c.push("SP");if(arguments.length>1&&arguments[1])f="SP";return D};D.stackedMode=function(t){if(!arguments.length){f="S";return D}if(!arguments[0])c.push("S");if(arguments.length>1&&arguments[1])f="S";return D};D.normalMode=function(t){if(!arguments.length){f="N";return D}if(!arguments[0])c.push("N");if(arguments.length>1&&arguments[1])f="N";return D};D.centerMode=function(t){if(!arguments.length){f="C";return D}if(!arguments[0])c.push("C");if(arguments.length>1&&arguments[1])f="C";return D};D.sort=function(t){if(!arguments.length)return m;m=t;return D};D.style=function(t){if(!arguments.length)return P;if(r.styles.hasOwnProperty(t))P=t;return D};var O=function(e){var a=e.length>1?e:[];B.append("g").attr("class","h2d3_controls").selectAll("g").data(a).enter().append("g").attr("class","h2d3_ctrl "+P).style("cursor","pointer").attr("pointer-events","all").attr("transform",function(t,e){return"translate(0,"+e*16+")"}).each(function(e,a){var n=t.select(this);n.append("circle").attr("class","h2d3_ctrl_circle "+P).attr("r","5");n.append("circle").attr("class",function(){if(e==f)return"h2d3_ctrl_dot h2d3_ctrl_dot_selected "+P;else return"h2d3_ctrl_dot "+P}).attr("r","2");n.append("text").attr("class","h2d3_ctrl_text").attr("dy",".32em").attr("dx","8").attr("text-anchor","start").text(function(){return r.modeNames[e]})}).on("click",function(e){if(e!=f){var r=t.select(this.parentNode).selectAll(".h2d3_ctrl_dot_selected").attr("class","h2d3_ctrl_dot "+P);K(e);t.select(this).selectAll(".h2d3_ctrl_dot").attr("class","h2d3_ctrl_dot h2d3_ctrl_dot_selected "+P)}})};var F=function(e,r){var a=20;var i=5;function l(e){var r=window.getComputedStyle(e,null).getPropertyValue("fill");t.select(e).attr("stroke",r).attr("stroke-width","2.5").attr("fill","none").attr("class","h2d3_legend_item_circle")}function s(e){var r=window.getComputedStyle(e,null).getPropertyValue("stroke");t.select(e).attr("stroke","none").attr("stroke-width","0.5").attr("fill",r)}B.append("g").attr("class","h2d3_legend").selectAll("g").data(e).enter().append("g").attr("class","h2d3_legend_item").style("cursor",v?"pointer":"auto").attr("pointer-events","all").each(function(e,r){var a=t.select(this);a.append("circle").attr("class",function(){return"h2d3_legend_item_circle h2d3_serie_"+R(e)}).attr("fill",function(t){return _.color(b[t].index)}).attr("stroke-width","0.5").attr("stroke","none").attr("r","5");a.append("text").attr("class",function(){return"h2d3_legend_item_text h2d3_serie_"+R(e)}).attr("dy",".32em").attr("dx","8").attr("text-anchor","start").attr("fill",function(t){return _.color(b[t].index)}).text(function(){return e})}).on("click",function(t){if(!v)return;if(p.indexOf(t)==-1){p.push(t);J(p);l(this.getElementsByClassName("h2d3_legend_item_circle")[0])}else{var e=p.indexOf(t);p.splice(e,1);J(p);s(this.getElementsByClassName("h2d3_legend_item_circle")[0])}});var u=B.select(".h2d3_legend")[0][0].getBBox().width+i;var c=1;while(Math.ceil(A/c)*u>n-r-a&&c<A)c++;B.selectAll(".h2d3_legend_item").attr("transform",function(t,e){return"translate("+Math.floor(e/c)*u+","+e%c*16+")"});B.select(".h2d3_legend").attr("transform",function(t,e){return"translate("+(n-o.left-o.right-u*Math.ceil(A/c))+",-"+c*16+")"})};var z=function(){M=e().attr("class","h2d3-tip "+P).offset([-10,0]).direction("n").html(function(t){var e=f=="SP"?t.percent:t.value;return' <span style="color:'+_.color(b[t.key].index)+'">'+t.key+'</span><span class="h2d3-tip_text '+P+'" > : '+h(e)+"</span>"});if(g){M.offset(function(t){var e=this.getAttribute("height");var r=this.getAttribute("width");return[-r/2-10,e/2]})}return M};function R(t){return t.replace(/[^A-Za-z0-9]/g,"-")}function V(t){var e=0;var r=0;t.series.forEach(function(a){a.cumx=e;a.cumxp=r;a.percent=a.value/t.total;e+=a.value;r+=a.percent})}var Z=function(t){var e=t.scale();if(g){var r=e.rangeBand();var a=0;B.select(".h2d3_axis.x").selectAll("text").each(function(){a=Math.max(this.getBBox().width,a)});if(a<r)return 0;B.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end").attr("transform","rotate(-30)");return B.select(".h2d3_axis.x")[0][0].getBBox().height}return 0};var j=function(){var e=t.svg.axis();var r;if(g){H();r=_["bar_"+f].copy();r.range([s,0]);e.tickFormat(h)}else{G();r=_.group}e.scale(r).orient("left");return e};var q=function(){var e=t.svg.axis();if(g){G();r=_.group}else{H();var r=_["bar_"+f];e.tickFormat(h)}e.scale(r).orient("bottom");return e};var G=function(){var e=g?l:s;_.group=t.scale.ordinal().domain(k.map(function(t){return t.label})).rangeRoundBands([0,e],.1);_.group_N=t.scale.ordinal().domain(t.range(A)).rangeRoundBands([0,_.group.rangeBand()])};var H=function(){var e=g?s:l;var r=999999999;var a=-999999999;var n=r;var i=a;k.forEach(function(t){var e=0;t.series.forEach(function(t,n){var i=t.value;r=Math.min(i,r);a=Math.max(i,a);e+=i;if(b[t.key].total>0)t.norm_value=i/b[t.key].total});t.total=e;i=Math.max(i,e);n=Math.min(n,e)});_.bar_N=t.scale.linear().range([0,e]).domain([Math.min(0,r),a]);_.bar_S=t.scale.linear().range([0,e]).domain([0,i]);_.bar_SP=t.scale.linear().range([0,e]).domain([0,1]);_.bar_C=t.scale.linear().range([0,e]).domain([-a,a])};y.N=function(t){var e=_.bar_N;t.attr("width",function(t){return Math.abs(e(t.value)-e(0))}).attr("height",_.group_N.rangeBand()).attr("x",function(t){return e(Math.min(0,t.value))}).attr("y",function(t,e){var r=_.group_N(b[t.key].index);if(r!==undefined)return r;return this.getAttribute("y")})},y.S=function(t){var e=_.bar_S;t.attr("width",function(t){return e(t.value)}).attr("height",_.group.rangeBand()).attr("x",function(t){return e(t.cumx)}).attr("y",0)},y.SP=function(t){var e=_.bar_SP;t.attr("width",function(t){return e(t.percent)}).attr("height",_.group.rangeBand()).attr("x",function(t){return e(t.cumxp)}).attr("y",0)},y.C=function(t){var e=_.bar_C;t.attr("width",function(t){return e(t.value)-e(0)}).attr("height",_.group.rangeBand()).attr("x",function(t,r){return b[t.key].index%2==0?e(-t.value):e(0)}).attr("y",0)};var I=function(t){if(g){S.tickSize(-l,0);t.select(".h2d3_axis.y").call(S)}else{E.tickSize(-s,0);t.select(".h2d3_axis.x").call(E)}};var J=function(e){p=e;k.map(function(t){var r=0;t.series.map(function(t){if(e.indexOf(t.key)>-1&&!t.hasOwnProperty("hvalue")){t.hvalue=t.value;t.value=0}else if(e.indexOf(t.key)==-1&&t.hasOwnProperty("hvalue")){t.value=t.hvalue;delete t.hvalue}r+=t.value});if(r==0)r=1;t.total=r});k.forEach(function(t){V(t)});H();var r=t.range(A);p.forEach(function(t){r.splice(r.indexOf(b[t].index),1)});_.group_N.domain(r);L()};var K=function(t){if(f==t)return;f=t;L()};var L=function(){var e=B.transition().duration(500);var r=_["bar_"+f];if(g){r=r.copy();r.range([s,0])}var a=g?S:E;a.scale(r);h=d;if(f=="SP")h=t.format(".2p");else if(f=="C")h=function(t){return d(Math.abs(t))};a.tickFormat(h);e.select(g?".y.h2d3_axis":".x.h2d3_axis").call(a);var n=y[f];e.selectAll(".h2d3_group rect.h2d3_bar").call(n)};var Q=function(t){if(t==""||t[0]!="-"){e=1}else{var e=-1;t=t.slice(1)}if(t==""){for(var r in b){if(b.hasOwnProperty(r)){b[r].index=b[r].initial}}k.forEach(function(t){t.series.sort(function(t,e){return b[t.key].index-b[e.key].index});V(t)});k.sort(function(t,e){return t.initial-e.initial})}else{var a=-1;var n=null;for(var r in b){if(b.hasOwnProperty(r)){if(b[r].index==0)n=b[r];if(r==t){a=b[r].index;b[r].index=0}}}if(a==-1)console.error("serie not found : ",t);if(n!=null)n.index=a;k.forEach(function(t){t.series.sort(function(t,e){return b[t.key].index-b[e.key].index});V(t)});var i=f=="SP"?"percent":"value";k.sort(function(r,a){var n=r.series[0].key==t?r.series[0][i]:0;var l=a.series[0].key==t?a.series[0][i]:0;return e*(n-l)})}_.group=_.group.domain(k.map(function(t){return t.label})).copy();var l=(g?E:S).scale(_.group);var s=B.transition().duration(500);s.select(g?".h2d3_axis.x":".h2d3_axis.y").delay(500).call(l);if(N){B.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end")}s.selectAll(".h2d3_group").attr("transform",function(t){return"translate(0,"+_.group(t.label)+")"}).delay(500);var o=y[f];s.selectAll(".h2d3_group rect.h2d3_bar").call(o)};var T=function(t){var e={};var r=[];t.forEach(function(t,a){var n={key:t.key,index:a,initial:a};var i=0;t.values.forEach(function(a,n){if(!e.hasOwnProperty(a.label)){var l=r.length;e[a.label]={label:a.label,series:[],initial:l};r.push(e[a.label])}e[a.label].series.push({key:t.key,value:a.value});i+=a.value;if(a.value<0)w=true});if(i==0)i=1;n.total=i;b[t.key]=n});e=null;return r};return D};return r});