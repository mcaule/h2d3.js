!function(t){"function"==typeof define&&define.amd?define(["d3","d3-tip"],t):d3&&d3.tip?window.h2d3=t(d3,d3.tip):window.h2d3=t(d3)}(function(t,e){var r={},n=!("undefined"==typeof e);return r.modeNames={N:"Normal",S:"Stacked",SP:"Percent",C:"Center"},r.styles={default:["#a6cee3","#ff7f00","#b2df8a","#1f78b4","#fdbf6f","#33a02c","#cab2d6","#6a3d9a","#fb9a99","#e31a1c","#ffff99","#b15928"],pastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"],darkpastel:["#61C0E7","#E381B8","#53CDB5","#DC8165","#C296C6","#70AEC3","#6BBA7F","#D39150","#DC7E87","#8DA4D5","#A0B350","#CEAA38"],colorblind:["#999999","#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00","#CC79A7"]},r.chart=function(){function a(e,y){S=y.length,E=T(y);var b=y.map(function(t){return t.key});d=c,h=u-f.bottom;for(var O=[],G=0;G<g.length;G++)2!=S&&"C"==g[G]||N&&"N"!=g[G]||p.indexOf(g[G])!=-1||O.push(g[G]);""==v?v=O[0]:O.indexOf(v)==-1&&(N?console.log("h2d3 : mode "+r.modeNames[v]+" not compatible with data (negatives values)"):console.log("h2d3 : mode "+r.modeNames[v]+" not compatible with data"),v=O[0]),P=t.select(e).append("svg").attr("class","h2d3 "+D).attr("width",d).attr("height",h+f.bottom).append("g"),z(O);var H=P.select(".h2d3_controls")[0][0].getBBox(),L=t.scale.ordinal().domain(t.range(S));null==A?L.range(r.styles[D]):L.range(A),w={color:L},R(b,H.width);var U=P.select(".h2d3_legend")[0][0].getBBox(),W=Math.max(U.height,H.height);P.select(".h2d3_controls").attr("transform","translate(0,-"+W+")"),f.top=f.top+W,h=h-f.top-f.bottom-f.axis;var X=P.append("g");_=x,"SP"==v?_=t.format(".2p"):"C"==v&&(_=function(t){return x(Math.abs(t))}),s=Z(),X.append("g").attr("class","h2d3_axis y "+D+" "+(m?"barAxis":"groupAxis")).call(s).attr("transform","translate(-"+f.axis+",0)");var Y=P.select(".h2d3_axis.y")[0][0].getBBox().width;d=d-(f.left+Y)-f.right-f.axis,P.attr("transform","translate("+f.left+","+f.top+")"),X.attr("transform","translate("+(f.axis+Y)+",0)"),o=q(),X.append("g").attr("class","h2d3_axis x "+D+" "+(m?"groupAxis":"barAxis")).attr("transform","translate(0,"+(h+f.axis)+")").call(o);var $=j(o);$>0&&(h-=$,s=Z(),X.select(".h2d3_axis.y").call(s),X.select(".h2d3_axis.x").attr("transform","translate(0,"+(h+f.axis)+")"),M=!0),X.insert("rect",":first-child").attr("width",d+f.axis).attr("height",h+f.axis).attr("x",-f.axis).attr("y",0).attr("class","h2d3_gridbg "+D),I(X);var tt=X.append("g");m&&tt.attr("transform","rotate(-90) translate(-"+h+",0)"),n&&(V(),tt.call(F),a.tip=F);var et=tt.selectAll(".h2d3_group").data(E).enter().append("g").attr("class","h2d3_group").attr("transform",function(t){return"translate(0,"+w.group(t.label)+")"}),rt=B[v],nt=et.selectAll(".h2d3_bar").data(function(t){return t.series.sort(function(t,e){return C[t.key].index-C[e.key].index}),i(t),t.series}).enter().append("rect").attr("class",function(t){return"h2d3_bar h2d3_serie_"+l(t.key)}).attr("fill",function(t){return L(C[t.key].index)}).call(rt);n&&nt.on("mouseover",F.show).on("mouseout",F.hide),""!=k&&Q(k),a.sort=Q,a.changeMode=K,a.hide=J}function l(t){return t.replace(/[^A-Za-z0-9]/g,"-")}function i(t){var e=0,r=0;t.series.forEach(function(n){n.cumx=e,n.cumxp=r,n.percent=n.value/t.total,e+=n.value,r+=n.percent})}var o,s,c=600,u=400,d=600,h=400,f={top:20,right:20,bottom:20,left:20,axis:5},g=["N","S","SP","C"],p=[],v="",x=t.format(),_=x,m=!1,y=!0,b=[],k="",A=null,w={},B={},C={},E=null,S=0,P=null,N=!1,M=!1,D="default",O=function(t){var e="SP"==v?t.percent:t.value;return' <span style="color:'+w.color(C[t.key].index)+'">'+t.key+'</span><span class="h2d3-tip_text '+D+'" > : '+_(e)+"</span>"},F=null;a.vertical=function(t){return arguments.length&&!t||(m=!0),a},a.width=function(t){return arguments.length?(c=t,a):c},a.height=function(t){return arguments.length?(u=t,a):u},a.tickFormat=function(e){return arguments.length?("string"==typeof e&&(e=t.format(e)),x=e,a):x},a.selectSeries=function(t){return arguments.length?(y=t,a):y},a.colors=function(t){return arguments.length?(A=t,a):A},a.margin=function(t){return arguments.length?(f=t,a):f},a.percentMode=function(t){return arguments.length?(arguments[0]||p.push("SP"),arguments.length>1&&arguments[1]&&(v="SP"),a):(v="SP",a)},a.stackedMode=function(t){return arguments.length?(arguments[0]||p.push("S"),arguments.length>1&&arguments[1]&&(v="S"),a):(v="S",a)},a.normalMode=function(t){return arguments.length?(arguments[0]||p.push("N"),arguments.length>1&&arguments[1]&&(v="N"),a):(v="N",a)},a.centerMode=function(t){return arguments.length?(arguments[0]||p.push("C"),arguments.length>1&&arguments[1]&&(v="C"),a):(v="C",a)},a.sort=function(t){return arguments.length?(k=t,a):k},a.style=function(t){return arguments.length?(r.styles.hasOwnProperty(t)&&(D=t),a):D},a.tipFunction=function(t){return arguments.length?(O=t,a):O},a.updateData=function(e){function r(t,e){for(var r=0;r<E.length;r++)if(E[r].label==t){for(var n=0;n<E[r].series.length;n++)if(E[r].series[n].key==e)return E[r].series[n].value;return null}return null}function n(t,r){for(var n=0;n<e.length;n++)if(e[n].key==r){for(var a=0;a<e[n].values.length;a++)if(e[n].values[a].label==t)return e[n].values[a].value;return null}return null}for(var l=0;l<e.length;l++)for(var o=0;o<e[l].values.length;o++){var s=r(e[l].values[o].label,e[l].key);if(null===s)return void console.error("[h2d3.js] Error : incorrect updateData, item does not exist in previous data :",e[l].values[o].label,e[l].key)}E.map(function(t){var e=0;t.series.map(function(r){r.value=n(t.label,r.key),r.hasOwnProperty("hvalue")&&(r.hvalue=r.value,r.value=0),e+=r.value}),0==e&&(e=1),t.total=e}),E.forEach(function(t){i(t)}),H();var c=t.range(S);return b.forEach(function(t){c.splice(c.indexOf(C[t].index),1)}),w.group_N.domain(c),L(),a};var z=function(e){var n=e.length>1?e:[];P.append("g").attr("class","h2d3_controls").selectAll("g").data(n).enter().append("g").attr("class","h2d3_ctrl "+D).style("cursor","pointer").attr("pointer-events","all").attr("transform",function(t,e){return"translate(0,"+16*e+")"}).each(function(e,n){var a=t.select(this);a.append("circle").attr("class","h2d3_ctrl_circle "+D).attr("r","5"),a.append("circle").attr("class",function(){return e==v?"h2d3_ctrl_dot h2d3_ctrl_dot_selected "+D:"h2d3_ctrl_dot "+D}).attr("r","2"),a.append("text").attr("class","h2d3_ctrl_text").attr("dy",".32em").attr("dx","8").attr("text-anchor","start").text(function(){return r.modeNames[e]})}).on("click",function(e){if(e!=v){t.select(this.parentNode).selectAll(".h2d3_ctrl_dot_selected").attr("class","h2d3_ctrl_dot "+D);K(e),t.select(this).selectAll(".h2d3_ctrl_dot").attr("class","h2d3_ctrl_dot h2d3_ctrl_dot_selected "+D)}})},R=function(e,r){function n(e){var r=window.getComputedStyle(e,null).getPropertyValue("fill");t.select(e).attr("stroke",r).attr("stroke-width","2.5").attr("fill","none").attr("class","h2d3_legend_item_circle")}function a(e){var r=window.getComputedStyle(e,null).getPropertyValue("stroke");t.select(e).attr("stroke","none").attr("stroke-width","0.5").attr("fill",r)}var i=20,o=5;P.append("g").attr("class","h2d3_legend").selectAll("g").data(e).enter().append("g").attr("class","h2d3_legend_item").style("cursor",y?"pointer":"auto").attr("pointer-events","all").each(function(e,r){var n=t.select(this);n.append("circle").attr("class",function(){return"h2d3_legend_item_circle h2d3_serie_"+l(e)}).attr("fill",function(t){return w.color(C[t].index)}).attr("stroke-width","0.5").attr("stroke","none").attr("r","5"),n.append("text").attr("class",function(){return"h2d3_legend_item_text h2d3_serie_"+l(e)}).attr("dy",".32em").attr("dx","8").attr("text-anchor","start").attr("fill",function(t){return w.color(C[t].index)}).text(function(){return e})}).on("click",function(e){if(y)if(b.indexOf(e)==-1)b.push(e),J(b),n(t.select(this).select(".h2d3_legend_item_circle")[0][0]);else{var r=b.indexOf(e);b.splice(r,1),J(b),a(t.select(this).select(".h2d3_legend_item_circle")[0][0])}});for(var s=P.select(".h2d3_legend")[0][0].getBBox().width+o,u=1;Math.ceil(S/u)*s>c-r-i&&u<S;)u++;P.selectAll(".h2d3_legend_item").attr("transform",function(t,e){return"translate("+Math.floor(e/u)*s+","+e%u*16+")"}),P.select(".h2d3_legend").attr("transform",function(t,e){return"translate("+(c-f.left-f.right-s*Math.ceil(S/u))+",-"+16*u+")"})},V=function(){return F=e().attr("class","h2d3-tip "+D).offset([-10,0]).direction("n").html(O),m&&F.offset(function(t){var e=this.getAttribute("height"),r=this.getAttribute("width");return[-r/2-10,e/2]}),F},j=function(t){var e=t.scale();if(m){var r=e.rangeBand(),n=0;return P.select(".h2d3_axis.x").selectAll("text").each(function(){n=Math.max(this.getBBox().width,n)}),n<r?0:(P.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end").attr("transform","rotate(-30)"),P.select(".h2d3_axis.x")[0][0].getBBox().height)}return 0},Z=function(){var e,r=t.svg.axis();return m?(H(),e=w["bar_"+v].copy(),e.range([h,0]),r.tickFormat(_)):(G(),e=w.group),r.scale(e).orient("left"),r},q=function(){var e=t.svg.axis();if(m)G(),r=w.group;else{H();var r=w["bar_"+v];e.tickFormat(_)}return e.scale(r).orient("bottom"),e},G=function(){var e=m?d:h;w.group=t.scale.ordinal().domain(E.map(function(t){return t.label})).rangeRoundBands([0,e],.1),w.group_N=t.scale.ordinal().domain(t.range(S)).rangeRoundBands([0,w.group.rangeBand()])},H=function(){var e=m?h:d,r=999999999,n=-999999999,a=r,l=n;E.forEach(function(t){var e=0;t.series.forEach(function(t,a){var l=t.value;r=Math.min(l,r),n=Math.max(l,n),e+=l,C[t.key].total>0&&(t.norm_value=l/C[t.key].total)}),t.total=e,l=Math.max(l,e),a=Math.min(a,e)}),w.bar_N=t.scale.linear().range([0,e]).domain([Math.min(0,r),n]),w.bar_S=t.scale.linear().range([0,e]).domain([0,l]),w.bar_SP=t.scale.linear().range([0,e]).domain([0,1]),w.bar_C=t.scale.linear().range([0,e]).domain([-n,n])};B.N=function(t){var e=w.bar_N;t.attr("width",function(t){return Math.abs(e(t.value)-e(0))}).attr("height",w.group_N.rangeBand()).attr("x",function(t){return e(Math.min(0,t.value))}).attr("y",function(t,e){var r=w.group_N(C[t.key].index);return void 0!==r?r:this.getAttribute("y")})},B.S=function(t){var e=w.bar_S;t.attr("width",function(t){return e(t.value)}).attr("height",w.group.rangeBand()).attr("x",function(t){return e(t.cumx)}).attr("y",0)},B.SP=function(t){var e=w.bar_SP;t.attr("width",function(t){return e(t.percent)}).attr("height",w.group.rangeBand()).attr("x",function(t){return e(t.cumxp)}).attr("y",0)},B.C=function(t){var e=w.bar_C;t.attr("width",function(t){return e(t.value)-e(0)}).attr("height",w.group.rangeBand()).attr("x",function(t,r){return e(C[t.key].index%2==0?-t.value:0)}).attr("y",0)};var I=function(t){m?(s.tickSize(-d,0),t.select(".h2d3_axis.y").call(s)):(o.tickSize(-h,0),t.select(".h2d3_axis.x").call(o))},J=function(e){b=e,E.map(function(t){var r=0;t.series.map(function(t){e.indexOf(t.key)>-1&&!t.hasOwnProperty("hvalue")?(t.hvalue=t.value,t.value=0):e.indexOf(t.key)==-1&&t.hasOwnProperty("hvalue")&&(t.value=t.hvalue,delete t.hvalue),r+=t.value}),0==r&&(r=1),t.total=r}),E.forEach(function(t){i(t)}),H();var r=t.range(S);b.forEach(function(t){r.splice(r.indexOf(C[t].index),1)}),w.group_N.domain(r),L()},K=function(t){v!=t&&(v=t,L())},L=function(){var e=P.transition().duration(500),r=w["bar_"+v];m&&(r=r.copy(),r.range([h,0]));var n=m?s:o;n.scale(r),_=x,"SP"==v?_=t.format(".2p"):"C"==v&&(_=function(t){return x(Math.abs(t))}),n.tickFormat(_),e.select(m?".y.h2d3_axis":".x.h2d3_axis").call(n);var a=B[v];e.selectAll(".h2d3_group rect.h2d3_bar").call(a)},Q=function(t){if(""==t||"-"!=t[0])e=1;else{var e=-1;t=t.slice(1)}if(""==t){for(var r in C)C.hasOwnProperty(r)&&(C[r].index=C[r].initial);E.forEach(function(t){t.series.sort(function(t,e){return C[t.key].index-C[e.key].index}),i(t)}),E.sort(function(t,e){return t.initial-e.initial})}else{var n=-1,a=null;for(var r in C)C.hasOwnProperty(r)&&(0==C[r].index&&(a=C[r]),r==t&&(n=C[r].index,C[r].index=0));n==-1&&console.error("serie not found : ",t),null!=a&&(a.index=n),E.forEach(function(t){t.series.sort(function(t,e){return C[t.key].index-C[e.key].index}),i(t)});var l="SP"==v?"percent":"value";E.sort(function(r,n){var a=r.series[0].key==t?r.series[0][l]:0,i=n.series[0].key==t?n.series[0][l]:0;return e*(a-i)})}w.group=w.group.domain(E.map(function(t){return t.label})).copy();var c=(m?o:s).scale(w.group),u=P.transition().duration(500);u.select(m?".h2d3_axis.x":".h2d3_axis.y").delay(500).call(c),M&&P.select(".h2d3_axis.x").selectAll("text").style("text-anchor","end"),u.selectAll(".h2d3_group").attr("transform",function(t){return"translate(0,"+w.group(t.label)+")"}).delay(500);var d=B[v];u.selectAll(".h2d3_group rect.h2d3_bar").call(d)},T=function(t){var e={},r=[];return t.forEach(function(t,n){var a={key:t.key,index:n,initial:n},l=0;t.values.forEach(function(n,a){if(!e.hasOwnProperty(n.label)){var i=r.length;e[n.label]={label:n.label,series:[],initial:i},r.push(e[n.label])}e[n.label].series.push({key:t.key,value:n.value}),l+=n.value,n.value<0&&(N=!0)}),0==l&&(l=1),a.total=l,C[t.key]=a}),e=null,r};return a},r});